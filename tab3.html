<!-- tab3.html - ì§„ë‹¨/ì‹œìˆ  eCRF -->
<<!-- tab3.html - ì§„ë‹¨/ì‹œìˆ  eCRF -->
<div id="ecrf-wrap" style="display: flex; height: 100%; font-family: 'Noto Sans KR', sans-serif;">
  <!-- ì¢Œì¸¡ ë„¤ë¹„ê²Œì´ì…˜ -->
  <aside style="width: 240px; background: #f8f9fa; border-right: 1.5px solid #dee2e6; padding: 20px 0;">
    <nav style="display: flex; flex-direction: column; gap: 8px;">
      <button class="ecrf-tab-btn active" data-tab="tab-patient-list">í™˜ì ëª©ë¡</button>
      <button class="ecrf-tab-btn" data-tab="tab-procedure-input">ì‹œìˆ  ì…ë ¥</button>
      <button class="ecrf-tab-btn" data-tab="tab-procedure-search">ì‹œìˆ  ì¡°íšŒ</button>
      <button class="ecrf-tab-btn" data-tab="tab-procedure-manage">ì‹œìˆ  ê´€ë¦¬</button>
      <button class="ecrf-tab-btn" data-tab="tab-icd-dictionary">ICD ì‚¬ì „</button>
    </nav>
  </aside>

  <!-- ìš°ì¸¡ ì½˜í…ì¸  -->
  <main style="flex: 1; padding: 32px; overflow-y: auto; background: #fff;">

    <!-- í™˜ì ëª©ë¡ -->
    <section id="tab-patient-list" class="ecrf-tab-content">
      <h2>í™˜ì ëª©ë¡</h2>

      <!-- ê²€ìƒ‰ ë° í•„í„° ì˜ì—­ -->
      <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 24px;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; align-items: end; margin-bottom: 16px;">
          <div>
            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #495057;">í™˜ì ê²€ìƒ‰</label>
            <input type="text" id="patient-search" placeholder="í™˜ìID, ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰" />
          </div>
          <div>
            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #495057;">ì„±ë³„</label>
            <select id="gender-filter">
              <option value="">ì „ì²´</option>
              <option value="M">ë‚¨ì„±</option>
              <option value="F">ì—¬ì„±</option>
            </select>
          </div>
          <div>
            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #495057;">ë‚˜ì´ ë²”ìœ„</label>
            <div style="display: flex; gap: 8px;">
              <input type="number" id="age-min" placeholder="ìµœì†Œ" style="width: 48%;" />
              <input type="number" id="age-max" placeholder="ìµœëŒ€" style="width: 48%;" />
            </div>
          </div>
          <div>
            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #495057;">ì…ì› ìƒíƒœ</label>
            <select id="admission-status-filter">
              <option value="">ì „ì²´</option>
              <option value="ì…ì›ì¤‘">ì…ì› ì¤‘</option>
              <option value="í‡´ì›">í‡´ì›</option>
            </select>
          </div>
          <div>
            <button class="ecrf-save-btn" id="search-patients" style="margin: 0;">ê²€ìƒ‰</button>
          </div>
        </div>

        <!-- í€µ í•„í„° ë²„íŠ¼ë“¤ -->
        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
          <button class="quick-filter-btn" data-filter="recent">ìµœê·¼ ì…ì›</button>
          <button class="quick-filter-btn" data-filter="current">í˜„ì¬ ì…ì›ì¤‘</button>
          <button class="quick-filter-btn" data-filter="elderly">65ì„¸ ì´ìƒ</button>
          <button class="quick-filter-btn" data-filter="male">ë‚¨ì„±</button>
          <button class="quick-filter-btn" data-filter="female">ì—¬ì„±</button>
        </div>
      </div>

      <!-- í™˜ì ëª©ë¡ í…Œì´ë¸” -->
      <div id="patient-list-container">
        <div style="margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center;">
          <div style="font-weight: 600; color: #495057;">
            <span id="patient-count-display">ì „ì²´ í™˜ì</span>
            <span style="font-size: 0.9em; color: #6c757d; margin-left: 8px;">(ìµœê·¼ ì…ì›ë‚ ì§œ ìˆœ)</span>
          </div>
          <div style="display: flex; gap: 8px;">
            <button id="refresh-patients" style="background: #17a2b8; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
              ğŸ”„ ìƒˆë¡œê³ ì¹¨
            </button>
          </div>
        </div>

        <div id="patient-table-wrapper" style="border: 1px solid #dee2e6; border-radius: 8px; overflow: hidden;">
          <table class="procedure-table" id="patient-table">
            <thead>
              <tr>
                <th style="width: 100px;">í™˜ì ID</th>
                <th style="width: 120px;">ì´ë¦„</th>
                <th style="width: 60px;">ì„±ë³„</th>
                <th style="width: 60px;">ë‚˜ì´</th>
                <th style="width: 120px;">ìƒë…„ì›”ì¼</th>
                <th style="width: 100px;">ì…ì› ID</th>
                <th style="width: 120px;">ì…ì›ì¼</th>
                <th style="width: 120px;">í‡´ì›ì¼</th>
                <th style="width: 100px;">ìƒíƒœ</th>
                <th style="width: 100px;">ì•¡ì…˜</th>
              </tr>
            </thead>
            <tbody id="patient-table-body">
              <tr>
                <td colspan="10" style="text-align: center; padding: 40px; color: #6c757d;">
                  í™˜ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
        <div id="patient-pagination" style="display: flex; justify-content: center; gap: 8px; margin-top: 16px; align-items: center;">
        </div>
      </div>

      <!-- í™˜ì ì„ íƒ ì•ˆë‚´ -->
      <div style="background: #e7f3ff; border: 1px solid #b3d7ff; border-radius: 8px; padding: 16px; margin-top: 24px;">
        <div style="display: flex; align-items: center; gap: 8px; color: #0066cc;">
          <span style="font-size: 18px;">ğŸ’¡</span>
          <span style="font-weight: 600;">ì‚¬ìš©ë²•:</span>
        </div>
        <ul style="margin: 8px 0 0 26px; color: #0066cc; line-height: 1.6;">
          <li><strong>ì‹œìˆ  ì…ë ¥:</strong> í™˜ìë¥¼ ë”ë¸”í´ë¦­í•˜ë©´ í•´ë‹¹ í™˜ìì˜ ì‹œìˆ  ì…ë ¥ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤</li>
          <li><strong>í™˜ì ì •ë³´:</strong> í™˜ìëª… ìœ„ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ ìƒì„¸ ì •ë³´ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
          <li><strong>ê²€ìƒ‰ ê¸°ëŠ¥:</strong> í™˜ìIDë‚˜ ì´ë¦„ìœ¼ë¡œ ë¹ ë¥´ê²Œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
        </ul>
      </div>
    </section>

    <!-- ì‹œìˆ  ì…ë ¥ -->
    <section id="tab-procedure-input" class="ecrf-tab-content" style="display: none;">
      <h2>ìƒˆ ì‹œìˆ  ì •ë³´ ì…ë ¥</h2>

      <!-- ì„ íƒëœ í™˜ì ì •ë³´ í‘œì‹œ ì˜ì—­ -->
      <div id="selected-patient-info" style="display: none; background: #e7f3ff; border: 1px solid #b3d7ff; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <h4 style="margin: 0 0 8px 0; color: #0066cc;">ì„ íƒëœ í™˜ì</h4>
            <div id="selected-patient-details" style="color: #0066cc;"></div>
          </div>
          <div>
            <button id="change-patient" style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
              í™˜ì ë³€ê²½
            </button>
          </div>
        </div>
      </div>

      <!-- ì‹¤ì‹œê°„ ì•Œë¦¼ ì˜ì—­ -->
      <div id="validation-alert" style="display: none; padding: 12px 16px; margin-bottom: 20px; border-radius: 8px; font-size: 14px; font-weight: 500;">
      </div>

      <table class="ecrf-form-table">
        <tr>
          <td>í™˜ì ID *</td>
          <td>
            <input type="text" id="subject_id" placeholder="í™˜ì ëª©ë¡ì—ì„œ ì„ íƒí•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥" />
            <div id="patient-info" style="margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 6px; display: none; font-size: 14px; color: #495057;">
            </div>
          </td>
        </tr>
        <tr>
          <td>ì…ì› ID *</td>
          <td>
            <input type="text" id="hadm_id" placeholder="ì…ì› ID ì…ë ¥" />
            <div id="admission-info" style="margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 6px; display: none; font-size: 14px; color: #495057;">
            </div>
          </td>
        </tr>
        <tr>
          <td>ì‹œìˆ  ìˆœë²ˆ</td>
          <td>
            <input type="number" id="seq_num" placeholder="ìë™ ê³„ì‚°ë¨" readonly style="background: #f8f9fa;" />
            <small style="color: #6c757d; margin-left: 8px;">í•´ë‹¹ ì…ì›ì˜ ë‹¤ìŒ ìˆœë²ˆì´ ìë™ìœ¼ë¡œ ì„¤ì •ë©ë‹ˆë‹¤</small>
          </td>
        </tr>
        <tr>
          <td>ì‹œìˆ  ì¼ì *</td>
          <td>
            <div style="display: flex; gap: 8px; align-items: center;">
              <!-- ë‚ ì§œ ì…ë ¥ -->
              <input type="date" id="chartdate_date" style="width: 150px;" />

              <!-- ì‹œê°„ ì…ë ¥ -->
              <input type="time" id="chartdate_time" style="width: 120px;" value="09:00" />

              <!-- ìˆ¨ê²¨ì§„ datetime-local (ì‹¤ì œ ì €ì¥ìš©) -->
              <input type="datetime-local" id="chartdate" style="display: none;" />
            </div>
            <small id="date-validation" style="color: #6c757d; margin-left: 8px; display: block; margin-top: 4px;"></small>
          </td>
        </tr>
        <tr>
          <td>ICD ì½”ë“œ *</td>
          <td>
            <div style="position: relative;">
              <input type="text" id="icd_code" placeholder="ICD ì½”ë“œ ë˜ëŠ” ì‹œìˆ ëª…ìœ¼ë¡œ ê²€ìƒ‰" autocomplete="off" />
              <div id="icd-suggestions" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #dee2e6; border-top: none; border-radius: 0 0 6px 6px; max-height: 200px; overflow-y: auto; z-index: 1000; display: none;">
              </div>
            </div>
          </td>
        </tr>
        <tr>
          <td>ICD ë²„ì „ *</td>
          <td>
            <div class="ecrf-radio-group">
              <label><input type="radio" name="icd_version" value="9" /> ICD-9</label>
              <label><input type="radio" name="icd_version" value="10" checked /> ICD-10</label>
            </div>
          </td>
        </tr>
        <tr>
          <td>ì‹œìˆ ëª…</td>
          <td>
            <input type="text" id="long_title" placeholder="ICD ì½”ë“œ ì„ íƒì‹œ ìë™ ì…ë ¥" readonly style="background: #f8f9fa;" />
          </td>
        </tr>
        <tr>
          <td>ë¹„ê³ </td>
          <td>
            <textarea id="comments" rows="3" placeholder="ì¶”ê°€ ì •ë³´ë‚˜ íŠ¹ì´ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
          </td>
        </tr>
      </table>

      <div style="display: flex; gap: 12px; margin-top: 24px;">
        <button class="ecrf-save-btn" id="save-procedure">ì €ì¥</button>
        <button class="ecrf-reset-btn" id="reset-form">ì´ˆê¸°í™”</button>
        <button class="ecrf-preview-btn" id="preview-data">ë¯¸ë¦¬ë³´ê¸°</button>
      </div>

      <!-- ìµœê·¼ ì…ë ¥ ì´ë ¥ -->
      <div style="margin-top: 40px;">
        <h3>ìµœê·¼ ì…ë ¥ ì´ë ¥</h3>
        <div id="recent-procedures" style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 8px;">
          <div style="padding: 20px; text-align: center; color: #6c757d;">ìµœê·¼ ì…ë ¥ëœ ì‹œìˆ ì´ ì—†ìŠµë‹ˆë‹¤</div>
        </div>
      </div>
    </section>

    <!-- ì‹œìˆ  ì¡°íšŒ -->
    <section id="tab-procedure-search" class="ecrf-tab-content" style="display: none;">
      <h2>ì‹œìˆ  ì •ë³´ ì¡°íšŒ</h2>

      <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 24px;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; align-items: end;">
          <div>
            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #495057;">í™˜ì ID</label>
            <input type="text" id="search_subject_id" placeholder="í™˜ì ID" />
          </div>
          <div>
            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #495057;">ì…ì› ID</label>
            <input type="text" id="search_hadm_id" placeholder="ì…ì› ID" />
          </div>
          <div>
            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #495057;">ICD ì½”ë“œ</label>
            <input type="text" id="search_icd_code" placeholder="ICD ì½”ë“œ" />
          </div>
          <div>
            <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #495057;">ê¸°ê°„</label>
            <input type="date" id="search_date_from" style="width: 48%; margin-right: 4%;" />
            <input type="date" id="search_date_to" style="width: 48%;" />
          </div>
          <div>
            <button class="ecrf-save-btn" id="search-procedures" style="margin: 0;">ì¡°íšŒ</button>
          </div>
        </div>
      </div>

      <div id="search-results">
        <div style="padding: 40px; text-align: center; color: #6c757d; border: 2px dashed #dee2e6; border-radius: 8px;">
          ğŸ“‹ ì¡°íšŒ ì¡°ê±´ì„ ì„¤ì •í•˜ê³  'ì¡°íšŒ' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”
        </div>
      </div>
    </section>

    <!-- ì‹œìˆ  ê´€ë¦¬ -->
    <section id="tab-procedure-manage" class="ecrf-tab-content" style="display: none;">
      <h2>ì‹œìˆ  ì •ë³´ ìˆ˜ì •/ì‚­ì œ</h2>

      <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
        <div style="display: flex; align-items: center; gap: 8px; color: #856404;">
          <span style="font-size: 18px;">âš ï¸</span>
          <span style="font-weight: 600;">ì£¼ì˜ì‚¬í•­:</span>
          <span>ì‹œìˆ  ì •ë³´ ìˆ˜ì •/ì‚­ì œëŠ” ì‹ ì¤‘í•˜ê²Œ ì§„í–‰í•˜ì„¸ìš”. ë³€ê²½ëœ ë‚´ìš©ì€ ì¦‰ì‹œ ë°ì´í„°ë² ì´ìŠ¤ì— ë°˜ì˜ë©ë‹ˆë‹¤.</span>
        </div>
      </div>

      <div style="margin-bottom: 20px;">
        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #495057;">í™˜ì IDë¡œ ê²€ìƒ‰</label>
        <div style="display: flex; gap: 12px; align-items: center;">
          <input type="text" id="manage_subject_id" placeholder="í™˜ì ID ì…ë ¥" style="flex: 1;" />
          <button class="ecrf-save-btn" id="load-patient-procedures">í™˜ì ì‹œìˆ  ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
        </div>
      </div>

      <div id="manage-results">
        <div style="padding: 40px; text-align: center; color: #6c757d; border: 2px dashed #dee2e6; border-radius: 8px;">
          ğŸ‘¤ í™˜ì IDë¥¼ ì…ë ¥í•˜ê³  'í™˜ì ì‹œìˆ  ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°'ë¥¼ í´ë¦­í•˜ì„¸ìš”
        </div>
      </div>
    </section>

    <!-- ICD ì‚¬ì „ -->
    <section id="tab-icd-dictionary" class="ecrf-tab-content" style="display: none;">
      <h2>ICD ì‹œìˆ  ì½”ë“œ ì‚¬ì „</h2>

      <div style="margin-bottom: 24px;">
        <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 16px;">
          <input type="text" id="icd-search" placeholder="ICD ì½”ë“œ ë˜ëŠ” ì‹œìˆ ëª…ìœ¼ë¡œ ê²€ìƒ‰..." style="flex: 1;" />
          <select id="icd-version-filter">
            <option value="">ëª¨ë“  ë²„ì „</option>
            <option value="9">ICD-9</option>
            <option value="10">ICD-10</option>
          </select>
          <button class="ecrf-save-btn" id="search-icd-dict">ê²€ìƒ‰</button>
        </div>

        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
          <button class="quick-search-btn" data-search="ì‹¬ì¥">ì‹¬ì¥</button>
          <button class="quick-search-btn" data-search="ìˆ˜ìˆ ">ìˆ˜ìˆ </button>
          <button class="quick-search-btn" data-search="ì œê±°">ì œê±°ìˆ </button>
          <button class="quick-search-btn" data-search="ì‚½ì…">ì‚½ì…ìˆ </button>
          <button class="quick-search-btn" data-search="ë³µêµ¬">ë³µêµ¬ìˆ </button>
          <button class="quick-search-btn" data-search="ì ˆì œ">ì ˆì œìˆ </button>
        </div>
      </div>

      <div id="icd-dictionary-results">
        <div style="padding: 40px; text-align: center; color: #6c757d; border: 2px dashed #dee2e6; border-radius: 8px;">
          ğŸ” ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ í€µ ê²€ìƒ‰ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ICD ì½”ë“œë¥¼ ì°¾ì•„ë³´ì„¸ìš”
        </div>
      </div>
    </section>

  </main>
</div>

<!-- ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ -->
<div id="preview-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
  <div style="background: white; border-radius: 12px; padding: 24px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
    <h3 style="margin-top: 0; color: #3A86FF;">ì…ë ¥ ë‚´ìš© ë¯¸ë¦¬ë³´ê¸°</h3>
    <div id="preview-content"></div>
    <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px;">
      <button id="confirm-save" class="ecrf-save-btn">ì €ì¥ í™•ì¸</button>
      <button id="cancel-save" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer;">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<style>
.ecrf-tab-btn {
  background: none;
  border: none;
  text-align: left;
  padding: 12px 24px;
  font-size: 1.06em;
  cursor: pointer;
  color: #343A40;
  transition: background 0.2s;
  width: 100%;
  border-radius: 8px;
  margin: 2px 8px;
}
.ecrf-tab-btn:hover {
  background: #e9ecef;
  color: #3A86FF;
  font-weight: 600;
}
.ecrf-tab-btn.active {
  background-color: #E0EDFF;
  color: #3A86FF;
  font-weight: 700;
  border-left: 4px solid #3A86FF;
  padding-left: 20px;
}

.ecrf-tab-content input,
.ecrf-tab-content select,
.ecrf-tab-content textarea {
  width: 100%;
  padding: 10px 14px;
  font-size: 1em;
  border: 1.5px solid #ced4da;
  border-radius: 8px;
  box-sizing: border-box;
  transition: border-color 0.2s, box-shadow 0.2s;
}
.ecrf-tab-content input:focus,
.ecrf-tab-content select:focus,
.ecrf-tab-content textarea:focus {
  outline: none;
  border-color: #3A86FF;
  box-shadow: 0 0 0 3px rgba(58, 134, 255, 0.1);
}
.ecrf-tab-content input.error {
  border-color: #dc3545;
  box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
}
.ecrf-tab-content input.success {
  border-color: #28a745;
  box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
}

.ecrf-form-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0 12px;
  margin-bottom: 20px;
}
.ecrf-form-table td {
  padding: 8px 12px;
  vertical-align: top;
  font-size: 0.98em;
  color: #212529;
}
.ecrf-form-table td:first-child {
  width: 180px;
  font-weight: 600;
  color: #495057;
  text-align: right;
  padding-right: 18px;
}

.ecrf-radio-group label {
  display: inline-flex;
  align-items: center;
  margin-right: 24px;
  font-weight: 500;
  color: #343A40;
  font-size: 0.97em;
  cursor: pointer;
}
.ecrf-radio-group input[type="radio"] {
  margin-right: 8px;
  transform: scale(1.2);
  width: auto;
}

.ecrf-save-btn {
  background: #3A86FF;
  color: white;
  padding: 12px 24px;
  border: none;
  font-weight: 600;
  border-radius: 8px;
  cursor: pointer;
  font-size: 1.05em;
  transition: background 0.2s;
}
.ecrf-save-btn:hover {
  background: #0056b3;
}

.ecrf-reset-btn {
  background: #6c757d;
  color: white;
  padding: 12px 24px;
  border: none;
  font-weight: 600;
  border-radius: 8px;
  cursor: pointer;
  font-size: 1.05em;
  transition: background 0.2s;
}
.ecrf-reset-btn:hover {
  background: #545b62;
}

.ecrf-preview-btn {
  background: #17a2b8;
  color: white;
  padding: 12px 24px;
  border: none;
  font-weight: 600;
  border-radius: 8px;
  cursor: pointer;
  font-size: 1.05em;
  transition: background 0.2s;
}
.ecrf-preview-btn:hover {
  background: #117a8b;
}

.quick-filter-btn {
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  color: #495057;
  padding: 6px 12px;
  border-radius: 20px;
  cursor: pointer;
  font-size: 0.9em;
  transition: all 0.2s;
}
.quick-filter-btn:hover, .quick-filter-btn.active {
  background: #007bff;
  color: white;
  border-color: #007bff;
}

.quick-search-btn {
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  color: #495057;
  padding: 6px 12px;
  border-radius: 20px;
  cursor: pointer;
  font-size: 0.9em;
  transition: all 0.2s;
}
.quick-search-btn:hover, .quick-search-btn.active {
  background: #007bff;
  color: white;
  border-color: #007bff;
}

.patient-tooltip {
  position: absolute;
  background: #343a40;
  color: white;
  padding: 12px 16px;
  border-radius: 6px;
  font-size: 0.9em;
  z-index: 1001;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  max-width: 300px;
  line-height: 1.4;
}

.patient-row {
  cursor: pointer;
  transition: background-color 0.2s;
}
.patient-row:hover {
  background-color: #f1f8ff !important;
}
.patient-row.selected {
  background-color: #cce7ff !important;
}

.pagination-btn {
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  color: #495057;
  padding: 8px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.9em;
  min-width: 40px;
  text-align: center;
  transition: all 0.2s;
}
.pagination-btn:hover:not(.disabled) {
  background: #3A86FF;
  color: white;
  border-color: #3A86FF;
}
.pagination-btn.active {
  background: #3A86FF;
  color: white;
  border-color: #3A86FF;
}
.pagination-btn.disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.suggestion-item {
  padding: 10px 14px;
  cursor: pointer;
  border-bottom: 1px solid #f1f3f5;
  transition: background 0.2s;
}
.suggestion-item:hover {
  background: #f8f9fa;
}
.suggestion-item:last-child {
  border-bottom: none;
}

.recent-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  border-bottom: 1px solid #f1f3f5;
  transition: background 0.2s;
}
.recent-item:hover {
  background: #f8f9fa;
}
.recent-item:last-child {
  border-bottom: none;
}

.procedure-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
  font-size: 0.95em;
  border: 1px solid #dee2e6;
  border-radius: 8px;
  overflow: hidden;
}
.procedure-table th {
  background: #f1f3f5;
  font-weight: 600;
  color: #495057;
  padding: 12px;
  text-align: left;
  border-bottom: 2px solid #dee2e6;
}
.procedure-table td {
  padding: 12px;
  border-bottom: 1px solid #f1f3f5;
  vertical-align: middle;
}
.procedure-table tr:hover {
  background: #f8f9fa;
}

h2 {
  margin-bottom: 24px;
  color: #343A40;
  border-bottom: 2px solid #DEE2E6;
  padding-bottom: 10px;
}

h3 {
  margin-top: 20px;
  margin-bottom: 12px;
  color: #3A86FF;
  font-size: 1.2em;
  border-left: 4px solid #3A86FF;
  padding-left: 12px;
}

.alert-success {
  background: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}

.alert-error {
  background: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
}

.alert-warning {
  background: #fff3cd;
  color: #856404;
  border: 1px solid #ffeaa7;
}

.loading {
  opacity: 0.6;
  pointer-events: none;
}

/* ë°ì´í„° ì •í•©ì„± ê´€ë ¨ ìŠ¤íƒ€ì¼ */
.integrity-check {
  background: #e3f2fd;
  border-left: 4px solid #2196f3;
  padding: 12px 16px;
  margin: 8px 0;
  border-radius: 0 6px 6px 0;
}

.integrity-error {
  background: #ffebee;
  border-left: 4px solid #f44336;
  padding: 12px 16px;
  margin: 8px 0;
  border-radius: 0 6px 6px 0;
}

.integrity-success {
  background: #e8f5e8;
  border-left: 4px solid #4caf50;
  padding: 12px 16px;
  margin: 8px 0;
  border-radius: 0 6px 6px 0;
}

.duplicate-warning {
  background: #fff3e0;
  border: 1px solid #ffcc02;
  border-radius: 6px;
  padding: 12px;
  margin: 8px 0;
  color: #e65100;
}
</style>

<script>
// === tab3.htmlì˜ <script> íƒœê·¸ ë‚´ìš©ì„ ì´ê²ƒìœ¼ë¡œ ì™„ì „ êµì²´í•˜ì„¸ìš” ===

// === í•˜ë“œì½”ë”©ëœ ìƒ˜í”Œ ë°ì´í„° ===
const SAMPLE_PATIENTS = [
  {
    subject_id: 10001,
    name: 'ê¹€oo',
    gender: 'M',
    anchor_age: 45,
    dob: '1979-03-15',
    anchor_year: 2024,
    dod: null
  },
  {
    subject_id: 10002,
    name: 'ì´oo',
    gender: 'F',
    anchor_age: 62,
    dob: '1962-08-22',
    anchor_year: 2024,
    dod: null
  },
  {
    subject_id: 10003,
    name: 'ë°•oo',
    gender: 'M',
    anchor_age: 38,
    dob: '1986-11-08',
    anchor_year: 2024,
    dod: null
  },
  {
    subject_id: 10004,
    name: 'ìµœoo',
    gender: 'F',
    anchor_age: 29,
    dob: '1995-05-12',
    anchor_year: 2024,
    dod: null
  },
  {
    subject_id: 10005,
    name: 'ì²œoo',
    gender: 'M',
    anchor_age: 71,
    dob: '1953-12-03',
    anchor_year: 2024,
    dod: null
  },
  {
    subject_id: 20001,
    name: 'í•œoo',
    gender: 'F',
    anchor_age: 54,
    dob: '1970-09-17',
    anchor_year: 2024,
    dod: null
  },
  {
    subject_id: 20002,
    name: 'ì„oo',
    gender: 'M',
    anchor_age: 33,
    dob: '1991-07-25',
    anchor_year: 2024,
    dod: null
  },
  {
    subject_id: 30001,
    name: 'ì˜¤oo',
    gender: 'F',
    anchor_age: 41,
    dob: '1983-04-30',
    anchor_year: 2024,
    dod: null
  }
];

const SAMPLE_ADMISSIONS = [
  {
    subject_id: 10001,
    hadm_id: 25001,
    admittime: '2025-01-10T08:30:00',
    dischtime: '2025-01-15T14:20:00',
    admission_type: 'ELECTIVE',
    admission_location: 'CLINIC REFERRAL',
    discharge_location: 'HOME',
    hospital_expire_flag: 0
  },
  {
    subject_id: 10001,
    hadm_id: 25002,
    admittime: '2025-01-20T09:15:00',
    dischtime: null,
    admission_type: 'EMERGENCY',
    admission_location: 'EMERGENCY ROOM',
    discharge_location: null,
    hospital_expire_flag: 0
  },
  {
    subject_id: 10002,
    hadm_id: 25003,
    admittime: '2025-01-18T11:45:00',
    dischtime: '2025-01-25T16:30:00',
    admission_type: 'ELECTIVE',
    admission_location: 'CLINIC REFERRAL',
    discharge_location: 'HOME',
    hospital_expire_flag: 0
  },
  {
    subject_id: 10003,
    hadm_id: 25004,
    admittime: '2025-01-22T16:20:00',
    dischtime: null,
    admission_type: 'EMERGENCY',
    admission_location: 'EMERGENCY ROOM',
    discharge_location: null,
    hospital_expire_flag: 0
  },
  {
    subject_id: 10004,
    hadm_id: 25005,
    admittime: '2025-01-28T14:00:00',
    dischtime: '2025-01-30T10:30:00',
    admission_type: 'ELECTIVE',
    admission_location: 'CLINIC REFERRAL',
    discharge_location: 'HOME',
    hospital_expire_flag: 0
  },
  {
    subject_id: 10005,
    hadm_id: 25006,
    admittime: '2025-01-05T12:15:00',
    dischtime: null,
    admission_type: 'ELECTIVE',
    admission_location: 'CLINIC REFERRAL',
    discharge_location: null,
    hospital_expire_flag: 0
  }
];

const EXISTING_PROCEDURES = [
  {
    subject_id: 10001,
    hadm_id: 25002,
    seq_num: 1,
    chartdate: '2025-01-21T10:30:00',
    icd_code: '0066',
    icd_version: 9,
    long_title: 'ê²½í”¼ì  ê´€ìƒë™ë§¥ì„±í˜•ìˆ '
  },
  {
    subject_id: 10001,
    hadm_id: 25002,
    seq_num: 2,
    chartdate: '2025-01-23T14:15:00',
    icd_code: '3722',
    icd_version: 9,
    long_title: 'ì¢Œì‹¬ì‹¤ ë³´ì¡°ì¥ì¹˜ ì‚½ì…'
  },
  {
    subject_id: 10003,
    hadm_id: 25004,
    seq_num: 1,
    chartdate: '2025-01-23T09:45:00',
    icd_code: '3861',
    icd_version: 9,
    long_title: 'ê¸°ê´€ì ˆê°œìˆ '
  },
  {
    subject_id: 10005,
    hadm_id: 25006,
    seq_num: 1,
    chartdate: '2025-01-07T11:20:00',
    icd_code: '8845',
    icd_version: 9,
    long_title: 'ë³µê°•ê²½í•˜ ë‹´ë‚­ì ˆì œìˆ '
  },
  {
    subject_id: 10005,
    hadm_id: 25006,
    seq_num: 2,
    chartdate: '2025-01-12T15:40:00',
    icd_code: '0DTJ0ZZ',
    icd_version: 10,
    long_title: 'ë‹´ë‚­ ì ˆì œìˆ , ê°œë³µ'
  },
  {
    subject_id: 10005,
    hadm_id: 25006,
    seq_num: 3,
    chartdate: '2025-01-18T08:25:00',
    icd_code: '0DT60ZZ',
    icd_version: 10,
    long_title: 'ìœ„ ì¼ë¶€ ì ˆì œìˆ '
  }
];

const SAMPLE_DIAGNOSES = [
  {
    subject_id: 10001,
    hadm_id: 25002,
    seq_num: 1,
    icd_code: '41401',
    icd_version: 9,
    long_title: 'ê´€ìƒë™ë§¥ì£½ìƒê²½í™”ì¦'
  },
  {
    subject_id: 10001,
    hadm_id: 25002,
    seq_num: 2,
    icd_code: '42831',
    icd_version: 9,
    long_title: 'ê¸‰ì„± ì‹¬ê·¼ê²½ìƒ‰'
  },
  {
    subject_id: 10003,
    hadm_id: 25004,
    seq_num: 1,
    icd_code: '85121',
    icd_version: 9,
    long_title: 'ê¸°ê´€ ì†ìƒ'
  },
  {
    subject_id: 10005,
    hadm_id: 25006,
    seq_num: 1,
    icd_code: '57420',
    icd_version: 9,
    long_title: 'ë‹´ì„ì¦'
  },
  {
    subject_id: 10005,
    hadm_id: 25006,
    seq_num: 2,
    icd_code: '53140',
    icd_version: 9,
    long_title: 'ìœ„ê¶¤ì–‘'
  }
];

const VALID_ICD_CODES = [
  { code: '0066', version: '9', title: 'ê²½í”¼ì  ê´€ìƒë™ë§¥ì„±í˜•ìˆ ', category: 'ì‹¬ì¥' },
  { code: '3722', version: '9', title: 'ì¢Œì‹¬ì‹¤ ë³´ì¡°ì¥ì¹˜ ì‚½ì…', category: 'ì‹¬ì¥' },
  { code: '3995', version: '9', title: 'í˜ˆì•¡íˆ¬ì„', category: 'í˜ˆê´€' },
  { code: '02703ZZ', version: '10', title: 'ê´€ìƒë™ë§¥ í™•ì¥ìˆ ', category: 'ì‹¬ì¥' },
  { code: '3861', version: '9', title: 'ê¸°ê´€ì ˆê°œìˆ ', category: 'í˜¸í¡ê¸°' },
  { code: '0W9P00Z', version: '10', title: 'ê¸°ê´€ì ˆê°œìˆ ', category: 'í˜¸í¡ê¸°' },
  { code: '5A1935Z', version: '10', title: 'ê¸°ê³„í™˜ê¸°, 24-96ì‹œê°„', category: 'í˜¸í¡ê¸°' },
  { code: '5A1945Z', version: '10', title: 'ê¸°ê³„í™˜ê¸°, 96ì‹œê°„ ì´ˆê³¼', category: 'í˜¸í¡ê¸°' },
  { code: '8845', version: '9', title: 'ë³µê°•ê²½í•˜ ë‹´ë‚­ì ˆì œìˆ ', category: 'ì†Œí™”ê¸°' },
  { code: '0DTJ0ZZ', version: '10', title: 'ë‹´ë‚­ ì ˆì œìˆ , ê°œë³µ', category: 'ì†Œí™”ê¸°' },
  { code: '0DT60ZZ', version: '10', title: 'ìœ„ ì¼ë¶€ ì ˆì œìˆ ', category: 'ì†Œí™”ê¸°' },
  { code: '8842', version: '9', title: 'ì§„ë‹¨ì  ë³µê°•ê²½ê²€ì‚¬', category: 'ì†Œí™”ê¸°' },
  { code: '8851', version: '9', title: 'ê´€ì ˆê²½í•˜ ë¬´ë¦ ë°˜ì›”ìƒì—°ê³¨ ì ˆì œìˆ ', category: 'ì •í˜•ì™¸ê³¼' },
  { code: '0QB50ZZ', version: '10', title: 'ë°˜ì›”ìƒì—°ê³¨ ì ˆì œìˆ ', category: 'ì •í˜•ì™¸ê³¼' },
  { code: '9604', version: '9', title: 'ì •ë§¥ë‚´ ë§ˆì·¨', category: 'ë§ˆì·¨' },
  { code: '3E030FZ', version: '10', title: 'ë§ˆì·¨ì œ ì£¼ì…', category: 'ë§ˆì·¨' },
  { code: '0JH60XZ', version: '10', title: 'í”¼í•˜ì¡°ì§ ë° ê·¼ë§‰ ì‚½ì…', category: 'ê¸°íƒ€' },
  { code: '5A1D00Z', version: '10', title: 'í˜ˆì•¡íˆ¬ì„, ë‹¨ì¼', category: 'í˜ˆê´€' }
];

const PROCEDURE_DIAGNOSIS_RULES = {
  '0066': ['41401', '42831', 'I2101', 'I2102'],
  '3722': ['42831', '42830', 'I2101'],
  '3861': ['85121', '51881', 'J440', 'S120'],
  '8845': ['57420', '57440', 'K802', 'K804'],
  '0DTJ0ZZ': ['57420', '57440', 'K802'],
  '0DT60ZZ': ['53140', '15130', 'K259', 'C160']
};

// === ì „ì—­ ë³€ìˆ˜ ===
let recentProcedures = JSON.parse(localStorage.getItem('recentProcedures') || '[]');
let icdData = [];
let selectedPatient = null;
let currentPatientData = [];
let currentPage = 1;
let itemsPerPage = 10;
let totalPatients = 0;
let isInitialized = false;

// === í•µì‹¬ ê²€ì¦ í•¨ìˆ˜ë“¤ ===
function validateProcedureDiagnosisCompatibility(subjectId, hadmId, icdCode) {
  console.log('ğŸ” ì‹œìˆ -ì§„ë‹¨ ì •í•©ì„± ê²€ì¦:', subjectId, hadmId, icdCode);

  // ğŸ”¥ ì‹œìˆ ëª… ì°¾ê¸°
  const icdVersionRadio = document.querySelector('input[name="icd_version"]:checked');
  const version = icdVersionRadio ? icdVersionRadio.value : '9';
  const procedureInfo = VALID_ICD_CODES.find(item =>
    item.code === icdCode && item.version === version
  );
  const procedureName = procedureInfo ? procedureInfo.title : icdCode;

  const patientDiagnoses = SAMPLE_DIAGNOSES.filter(d =>
    d.subject_id == subjectId && d.hadm_id == hadmId
  );

  const requiredDiagnoses = PROCEDURE_DIAGNOSIS_RULES[icdCode];

  if (!requiredDiagnoses) {
    return {
      valid: true,
      level: 'info',
      message: `â„¹ï¸ ${procedureName} ì‹œìˆ ì— ëŒ€í•œ íŠ¹ë³„í•œ ì§„ë‹¨ ìš”êµ¬ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.`
    };
  }

  const hasRequiredDiagnosis = patientDiagnoses.some(patientDx =>
    requiredDiagnoses.includes(patientDx.icd_code)
  );

  if (hasRequiredDiagnosis) {
    const matchingDx = patientDiagnoses.find(patientDx =>
      requiredDiagnoses.includes(patientDx.icd_code)
    );
    return {
      valid: true,
      level: 'success',
      message: `âœ… ${procedureName} ì‹œìˆ ê³¼ ${matchingDx.long_title} ì§„ë‹¨ì´ ì¼ì¹˜í•©ë‹ˆë‹¤.`
    };
  } else {
    return {
      valid: false,
      level: 'warning',
      message: `âš ï¸ ${procedureName} ì‹œìˆ ì—ëŠ” ê´€ë ¨ ì§„ë‹¨ì´ í•„ìš”í•©ë‹ˆë‹¤. (í•„ìš”: ì‹¬ì¥ì§ˆí™˜ ì§„ë‹¨)`
    };
  }
}

// === ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ ===
function resetAdmissionDropdown() {
  const dropdown = document.getElementById('hadm_id_dropdown');
  if (dropdown) {
    dropdown.style.display = 'none';
  }
  const hadmInput = document.getElementById('hadm_id');
  if (hadmInput) {
    hadmInput.style.display = 'block';
    hadmInput.value = '';
  }
}

function showAdmissionMessage(message) {
  const admissionInfo = document.getElementById('admission-info');
  if (admissionInfo) {
    admissionInfo.innerHTML = `<span style="color: #ffc107;">${message}</span>`;
    admissionInfo.style.display = 'block';
  }
}

function clearProcedureName() {
  const titleInput = document.getElementById('long_title');
  if (titleInput) {
    titleInput.value = '';
    titleInput.style.color = '#6c757d';
    titleInput.style.fontWeight = 'normal';
  }

  const hintDiv = document.getElementById('icd-name-hint');
  if (hintDiv) {
    hintDiv.remove();
  }
}

// ğŸ”¥ ì „ì—­ í•¨ìˆ˜ ì—…ë°ì´íŠ¸
window.selectICDCode = function(code, title) {
  const icdInput = document.getElementById('icd_code');
  const titleInput = document.getElementById('long_title');

  if (icdInput) icdInput.value = code;
  if (titleInput) {
    titleInput.value = title;
    titleInput.style.color = '#28a745';
    titleInput.style.fontWeight = '600';
  }

  hideSuggestions();
  showICDNameHint(code, title);

  setTimeout(() => {
    validateICDCode();
    performRealTimeValidation();
  }, 100);
};

console.log('ğŸ¯ ì‚¬ìš©ì„± ê°œì„  ì½”ë“œ ë¡œë“œ ì™„ë£Œ!');

function checkDuplicateProcedure(subjectId, hadmId, icdCode, chartdate) {
  console.log('ğŸ” ì¤‘ë³µ ì‹œìˆ  ê²€ì¦:', subjectId, hadmId, icdCode);

  const existingProcedures = EXISTING_PROCEDURES.filter(proc =>
    proc.subject_id == subjectId &&
    proc.hadm_id == hadmId &&
    proc.icd_code === icdCode
  );

  if (existingProcedures.length > 0) {
    const lastProcedure = existingProcedures[existingProcedures.length - 1];
    const daysDiff = Math.floor((new Date(chartdate) - new Date(lastProcedure.chartdate)) / (1000 * 60 * 60 * 24));

    if (daysDiff < 1) {
      return {
        isDuplicate: true,
        level: 'error',
        message: `âŒ ë™ì¼í•œ ì‹œìˆ ì´ ê°™ì€ ë‚  ì´ë¯¸ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤. (${new Date(lastProcedure.chartdate).toLocaleDateString()})`
      };
    } else if (daysDiff < 7) {
      return {
        isDuplicate: true,
        level: 'warning',
        message: `âš ï¸ ë™ì¼í•œ ì‹œìˆ ì´ ${daysDiff}ì¼ ì „ì— ì‹œí–‰ë˜ì—ˆìŠµë‹ˆë‹¤. ì¬ì‹œìˆ ì´ ë§ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.`
      };
    }
  }

  return {
    isDuplicate: false,
    level: 'success',
    message: 'âœ… ì¤‘ë³µëœ ì‹œìˆ ì´ ì—†ìŠµë‹ˆë‹¤.'
  };
}

function validateProcedureSequence(subjectId, hadmId, chartdate, seqNum) {
  console.log('ğŸ” ì‹œìˆ  ìˆœì„œ ê²€ì¦:', subjectId, hadmId, seqNum);

  const admissionProcedures = EXISTING_PROCEDURES
    .filter(proc => proc.subject_id == subjectId && proc.hadm_id == hadmId)
    .sort((a, b) => new Date(a.chartdate) - new Date(b.chartdate));

  if (admissionProcedures.length === 0) {
    return {
      valid: true,
      level: 'info',
      message: 'ì²« ë²ˆì§¸ ì‹œìˆ ì…ë‹ˆë‹¤.'
    };
  }

  const newProcedureDate = new Date(chartdate);
  const lastProcedureDate = new Date(admissionProcedures[admissionProcedures.length - 1].chartdate);

  if (newProcedureDate < lastProcedureDate) {
    return {
      valid: false,
      level: 'warning',
      message: `âš ï¸ ì‹œìˆ  ë‚ ì§œê°€ ì´ì „ ì‹œìˆ ë³´ë‹¤ ë¹ ë¦…ë‹ˆë‹¤. ìˆœì„œë¥¼ í™•ì¸í•˜ì„¸ìš”.`
    };
  }

  return {
    valid: true,
    level: 'success',
    message: 'âœ… ì‹œìˆ  ìˆœì„œê°€ ì˜¬ë°”ë¦…ë‹ˆë‹¤.'
  };
}

function performDataIntegrityCheck(formData) {
  const checks = [];

  // ğŸ”¥ ë‚ ì§œ ê²€ì¦ ì¶”ê°€
  const selectedDate = new Date(formData.chartdate);
  const today = new Date();

  if (selectedDate > today) {
    checks.push({
      type: 'date_validation',
      title: 'ë‚ ì§œ ê²€ì¦',
      valid: false,
      level: 'error',
      message: `âŒ ë¯¸ë˜ ë‚ ì§œëŠ” ì„ íƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (${selectedDate.toLocaleDateString()})`
    });
  } else {
    checks.push({
      type: 'date_validation',
      title: 'ë‚ ì§œ ê²€ì¦',
      valid: true,
      level: 'success',
      message: 'âœ… ì˜¬ë°”ë¥¸ ë‚ ì§œì…ë‹ˆë‹¤.'
    });
  }

  // ì‹œìˆ -ì§„ë‹¨ ì •í•©ì„± ê²€ì¦
  const diagnosisCheck = validateProcedureDiagnosisCompatibility(
    formData.subject_id,
    formData.hadm_id,
    formData.icd_code
  );
  checks.push({
    type: 'diagnosis_compatibility',
    title: 'ì‹œìˆ -ì§„ë‹¨ ì •í•©ì„±',
    ...diagnosisCheck
  });

  // ì¤‘ë³µ ì‹œìˆ  ê²€ì¦
  const duplicateCheck = checkDuplicateProcedure(
    formData.subject_id,
    formData.hadm_id,
    formData.icd_code,
    formData.chartdate
  );
  checks.push({
    type: 'duplicate_check',
    title: 'ì¤‘ë³µ ì‹œìˆ  ê²€ì¦',
    ...duplicateCheck
  });

  // ì‹œìˆ  ìˆœì„œ ê²€ì¦
  const sequenceCheck = validateProcedureSequence(
    formData.subject_id,
    formData.hadm_id,
    formData.chartdate,
    formData.seq_num
  );
  checks.push({
    type: 'sequence_check',
    title: 'ì‹œìˆ  ìˆœì„œ ê²€ì¦',
    ...sequenceCheck
  });

  return checks;
}

function displayIntegrityChecks(checks) {
  const container = document.getElementById('validation-alert');
  if (!container) return;

  let html = '<div style="font-weight: 600; margin-bottom: 8px;">ğŸ” ë°ì´í„° ì •í•©ì„± ê²€ì¦ ê²°ê³¼:</div>';

  checks.forEach(check => {
    const cssClass = check.level === 'error' ? 'integrity-error' :
                    check.level === 'warning' ? 'integrity-check' : 'integrity-success';

    const bgColor = check.level === 'error' ? '#ffebee' :
                   check.level === 'warning' ? '#fff3e0' : '#e8f5e8';
    const borderColor = check.level === 'error' ? '#f44336' :
                       check.level === 'warning' ? '#ff9800' : '#4caf50';

    html += `
      <div class="${cssClass}" style="margin: 4px 0; padding: 8px 12px; border-radius: 4px; font-size: 13px; background: ${bgColor}; border-left: 4px solid ${borderColor};">
        <strong>${check.title}:</strong> ${check.message}
      </div>
    `;
  });

  container.innerHTML = html;
  container.style.display = 'block';
}

// === ì‹¤ì‹œê°„ ê²€ì¦ í•¨ìˆ˜ ===
function performRealTimeValidation() {
  // ğŸ”¥ ì•ˆì „ì¥ì¹˜: updateSaveButtonState í•¨ìˆ˜ ì¡´ì¬ í™•ì¸
  if (typeof updateSaveButtonState !== 'function') {
    console.warn('âš ï¸ updateSaveButtonState í•¨ìˆ˜ê°€ ì•„ì§ ì •ì˜ë˜ì§€ ì•ŠìŒ');
    return { valid: false, hasErrors: true, hasWarnings: false };
  }

  const subjectId = document.getElementById('subject_id')?.value.trim();
  const hadmId = document.getElementById('hadm_id')?.value.trim();
  const chartdate = document.getElementById('chartdate')?.value;
  const icdCode = document.getElementById('icd_code')?.value.trim();
  const seqNum = document.getElementById('seq_num')?.value;

  if (!subjectId || !hadmId || !chartdate || !icdCode) {
    console.log('í•„ìˆ˜ í•„ë“œ ë¯¸ì…ë ¥, ê²€ì¦ ìŠ¤í‚µ');
    // ğŸ”¥ ì €ì¥ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    updateSaveButtonState(false, false, 'í•„ìˆ˜ ì •ë³´ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤');
    return { valid: false, hasErrors: true, hasWarnings: false };
  }

  console.log('ğŸ” ì‹¤ì‹œê°„ ê²€ì¦ ì‹œì‘:', { subjectId, hadmId, icdCode });

  const formData = {
    subject_id: subjectId,
    hadm_id: hadmId,
    chartdate: chartdate,
    icd_code: icdCode,
    seq_num: seqNum
  };

  const integrityChecks = performDataIntegrityCheck(formData);
  displayIntegrityChecks(integrityChecks);

  const hasErrors = integrityChecks.some(check => check.level === 'error');
  const hasWarnings = integrityChecks.some(check => check.level === 'warning');

  // ğŸ”¥ ì €ì¥ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
  updateSaveButtonState(!hasErrors, hasWarnings,
    hasErrors ? 'ì˜¤ë¥˜ë¥¼ ìˆ˜ì •í•œ í›„ ì €ì¥í•˜ì„¸ìš”' :
    hasWarnings ? 'ê²½ê³ ì‚¬í•­ì„ í™•ì¸í•˜ê³  ì €ì¥í•˜ì„¸ìš”' : 'ì €ì¥ ê°€ëŠ¥í•©ë‹ˆë‹¤');

  if (hasErrors) {
    console.log('âŒ ë°ì´í„° ì •í•©ì„± ì˜¤ë¥˜ ë°œê²¬');
  } else if (hasWarnings) {
    console.log('âš ï¸ ì£¼ì˜ì‚¬í•­ ë°œê²¬');
  } else {
    console.log('âœ… ëª¨ë“  ê²€ì¦ í†µê³¼');
  }

  return { valid: !hasErrors, hasErrors, hasWarnings };
}

// === ë‚˜ë¨¸ì§€ ëª¨ë“  í•¨ìˆ˜ë“¤ (ê°„ëµí™”) ===
function initializeTab3() {
  if (isInitialized) return;
  isInitialized = true;

  console.log('ğŸš€ tab3 ì´ˆê¸°í™” ì‹œì‘');

  if (!document.getElementById('ecrf-wrap')) {
    console.error('âŒ ecrf-wrap ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
    return;
  }

  try {
    setupTabNavigation();
    setupFormValidation();
    setupICDAutoComplete();
    setupEventHandlers();
    setupPatientListEvents();
    loadRecentProcedures();
    loadICDData();
    loadPatientList();

    console.log('âœ… tab3 ì´ˆê¸°í™” ì™„ë£Œ');
  } catch (error) {
    console.error('âŒ tab3 ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
    isInitialized = false;
  }
}

// === ëª¨ë“  ê¸°íƒ€ í•¨ìˆ˜ë“¤ (ê¸°ì¡´ ìœ ì§€) ===
function setupTabNavigation() {
  const tabButtons = document.querySelectorAll('.ecrf-tab-btn');
  const tabContents = document.querySelectorAll('.ecrf-tab-content');

  tabButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      tabButtons.forEach(b => b.classList.remove('active'));
      tabContents.forEach(content => content.style.display = 'none');
      btn.classList.add('active');
      const targetTab = document.getElementById(btn.dataset.tab);
      if (targetTab) targetTab.style.display = 'block';
    });
  });

  if (tabButtons.length > 0) {
    tabButtons[0].click();
  }
}

function setupFormValidation() {
  const subjectIdInput = document.getElementById('subject_id');
  const hadmIdInput = document.getElementById('hadm_id');
  const chartdateInput = document.getElementById('chartdate');
  const icdCodeInput = document.getElementById('icd_code');

  if (subjectIdInput) {
    subjectIdInput.addEventListener('blur', async function() {
      const subjectId = this.value.trim();
      if (subjectId) {
        await validateAndLoadPatientInfo(subjectId);
        performRealTimeValidation();
      }
    });
  }
async function validateAndLoadAdmissionInfo(subjectId, hadmId) {
  try {
    // ì…ì› IDë¡œ í™˜ì ID ì°¾ê¸° (ì…ì› IDë§Œ ì…ë ¥ëœ ê²½ìš°)
    if (!subjectId) {
      const admission = SAMPLE_ADMISSIONS.find(adm => adm.hadm_id == hadmId);
      if (admission) {
        document.getElementById('subject_id').value = admission.subject_id;
        await validateAndLoadPatientInfo(admission.subject_id);
        return;
      }
    }

    const response = await mockAPICall(`/api/admission/${subjectId}/${hadmId}`);
    if (response.success) {
      document.getElementById('hadm_id').classList.add('success');
      document.getElementById('hadm_id').classList.remove('error');

      const admissionInfo = document.getElementById('admission-info');
      if (admissionInfo) {
        const admitDate = new Date(response.data.admittime).toLocaleDateString();
        const dischargeInfo = response.data.dischtime ?
          `í‡´ì›ì¼: ${new Date(response.data.dischtime).toLocaleDateString()}` :
          '<span style="color: #28a745; font-weight: 600;">í˜„ì¬ ì…ì›ì¤‘ ğŸ¥</span>';

        admissionInfo.innerHTML = `
          <strong>ì…ì›ì¼:</strong> ${admitDate} |
          <strong>${dischargeInfo}</strong> |
          <strong>ì…ì› ìœ í˜•:</strong> ${response.data.admission_type}
        `;
        admissionInfo.style.display = 'block';
      }

      // ğŸ”¥ ì´ í™˜ìì˜ ê¸°ì¡´ ì‹œìˆ  ëª©ë¡ë„ í‘œì‹œ
      showExistingProcedures(subjectId, hadmId);

    } else {
      document.getElementById('hadm_id').classList.add('error');
      document.getElementById('hadm_id').classList.remove('success');
      const admissionInfo = document.getElementById('admission-info');
      if (admissionInfo) admissionInfo.style.display = 'none';
    }
  } catch (error) {
    console.error('ì…ì› ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:', error);
  }
}
  if (hadmIdInput) {
    hadmIdInput.addEventListener('blur', async function() {
      const hadmId = this.value.trim();
      const subjectId = subjectIdInput.value.trim();
      if (hadmId && subjectId) {
        await validateAndLoadAdmissionInfo(subjectId, hadmId);
        await calculateNextSeqNum(hadmId);
        performRealTimeValidation();
      }
    });
  }

  if (chartdateInput) {
    chartdateInput.addEventListener('change', function() {
      validateProcedureDate();
      performRealTimeValidation();
    });
  }

  if (icdCodeInput) {
    icdCodeInput.addEventListener('blur', function() {
      validateICDCode();
      performRealTimeValidation();
    });

    icdCodeInput.addEventListener('input', function() {
      if (this.value.trim().length >= 3) {
        setTimeout(() => {
          performRealTimeValidation();
        }, 500);
      }
    });
  }
}

// === ğŸ”¥ ë‚ ì§œ ë™ê¸°í™” ìˆ˜ì • ===
function setupDateTimeSync() {
  const dateInput = document.getElementById('chartdate_date');
  const timeInput = document.getElementById('chartdate_time');
  const datetimeInput = document.getElementById('chartdate');

  function updateDateTime() {
    if (dateInput && timeInput && datetimeInput && dateInput.value && timeInput.value) {
      const combinedDateTime = dateInput.value + 'T' + timeInput.value;
      datetimeInput.value = combinedDateTime;
      console.log('ğŸ“… ë‚ ì§œ ë™ê¸°í™”:', combinedDateTime);

      setTimeout(() => {
        validateProcedureDate();
        performRealTimeValidation();
      }, 100);
    }
  }

  if (dateInput) {
    const today = new Date();
    const todayString = today.getFullYear() + '-' +
                       String(today.getMonth() + 1).padStart(2, '0') + '-' +
                       String(today.getDate()).padStart(2, '0');
    dateInput.value = todayString;

    dateInput.addEventListener('change', updateDateTime);
    dateInput.addEventListener('input', updateDateTime);
  }

  if (timeInput) {
    timeInput.addEventListener('change', updateDateTime);
    timeInput.addEventListener('input', updateDateTime);
  }

  updateDateTime();
}

function validateProcedureDate() {
  const datetimeInput = document.getElementById('chartdate');
  const dateValidation = document.getElementById('date-validation');

  if (!datetimeInput || !datetimeInput.value) {
    if (dateValidation) dateValidation.textContent = '';
    return false;
  }

  const selectedDate = new Date(datetimeInput.value);
  const today = new Date();

  if (selectedDate > today) {
    if (dateValidation) {
      dateValidation.textContent = 'âš ï¸ ë¯¸ë˜ ë‚ ì§œëŠ” ì„ íƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
      dateValidation.style.color = '#dc3545';
    }
    datetimeInput.classList.add('error');
    setTimeout(performRealTimeValidation, 50);
    return false;
  } else {
    const diffDays = Math.floor((today - selectedDate) / (1000 * 60 * 60 * 24));
    if (dateValidation) {
      if (diffDays === 0) {
        dateValidation.textContent = 'âœ“ ì˜¤ëŠ˜ ì‹œìˆ ì…ë‹ˆë‹¤.';
      } else {
        dateValidation.textContent = `âœ“ ${diffDays}ì¼ ì „ ì‹œìˆ ì…ë‹ˆë‹¤.`;
      }
      dateValidation.style.color = '#28a745';
    }
    datetimeInput.classList.remove('error');
    datetimeInput.classList.add('success');
    return true;
  }
}

// === ê°„ëµí™”ëœ ê¸°íƒ€ í•¨ìˆ˜ë“¤ ===
function setupICDAutoComplete() { /* ê¸°ì¡´ ì½”ë“œ ìœ ì§€ */ }
function setupEventHandlers() { /* ê¸°ì¡´ ì½”ë“œ ìœ ì§€ */ }
function setupPatientListEvents() { /* ê¸°ì¡´ ì½”ë“œ ìœ ì§€ */ }
function loadRecentProcedures() { /* ê¸°ì¡´ ì½”ë“œ ìœ ì§€ */ }
function loadICDData() { icdData = VALID_ICD_CODES; }
function loadPatientList() { /* ê¸°ì¡´ ì½”ë“œ ìœ ì§€ */ }

// === ì „ì—­ í•¨ìˆ˜ë“¤ ì¶”ê°€ ===
window.initializeTab3 = initializeTab3;
window.performDataIntegrityCheck = performDataIntegrityCheck;
window.validateProcedureDiagnosisCompatibility = validateProcedureDiagnosisCompatibility;
window.checkDuplicateProcedure = checkDuplicateProcedure;
window.validateProcedureSequence = validateProcedureSequence;
window.displayIntegrityChecks = displayIntegrityChecks;
window.performRealTimeValidation = performRealTimeValidation;
window.selectICDCode = function(code, title) {
  const icdInput = document.getElementById('icd_code');
  const titleInput = document.getElementById('long_title');
  if (icdInput) icdInput.value = code;
  if (titleInput) titleInput.value = title;
  setTimeout(performRealTimeValidation, 100);
};

// === ì´ˆê¸°í™” ì‹¤í–‰ ===
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', function() {
    initializeTab3();
    setupDateTimeSync();
  });
} else {
  setTimeout(() => {
    initializeTab3();
    setupDateTimeSync();
  }, 100);
}

console.log('ğŸŒŸ tab3 ì™„ì „í•œ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì™„ë£Œ');

// === ì¶”ê°€ í•„ìˆ˜ í•¨ìˆ˜ë“¤ ===

// Mock API í˜¸ì¶œ í•¨ìˆ˜ë“¤
async function mockAPICall(url, method = 'GET', data = null) {
  await new Promise(resolve => setTimeout(resolve, Math.random() * 500 + 200));
  console.log('ğŸ” API í˜¸ì¶œ:', url, method, data);

  if (url.includes('patients/list') || url.includes('patients/search') || url.includes('/api/patients')) {
    let result = getPatientList();
    if (data && method === 'POST') {
      let filteredData = result.data;
      if (data.search) {
        const searchTerm = data.search.toLowerCase();
        filteredData = filteredData.filter(p =>
          p.subject_id.toString().includes(searchTerm) ||
          p.name.toLowerCase().includes(searchTerm)
        );
      }
      if (data.gender) filteredData = filteredData.filter(p => p.gender === data.gender);
      if (data.age_min) filteredData = filteredData.filter(p => p.age >= parseInt(data.age_min));
      if (data.age_max) filteredData = filteredData.filter(p => p.age <= parseInt(data.age_max));
      if (data.status) filteredData = filteredData.filter(p => p.status === data.status);
      result.data = filteredData;
      result.total = filteredData.length;
    }
    return result;
  }

  if (url.match(/\/api\/patient\/\d+$/) || url.match(/patient\/\d+$/)) {
    const subjectId = url.split('/').pop();
    return getPatientInfo(subjectId);
  }

  if (url.match(/\/api\/admission\/\d+\/\d+$/) || url.match(/admission\/\d+\/\d+$/)) {
    const parts = url.split('/');
    const hadmId = parts.pop();
    const subjectId = parts.pop();
    return getAdmissionInfo(subjectId, hadmId);
  }

  if (url.match(/\/api\/procedure\/next-seq\/\d+$/) || url.match(/next-seq\/\d+$/)) {
    const hadmId = url.split('/').pop();
    return getNextSequenceNumber(hadmId);
  }

  if (url.includes('procedure/save')) {
    return {
      success: Math.random() > 0.05,
      message: Math.random() > 0.05 ? 'Success' : 'Database connection error'
    };
  }

  return { success: true, data: [] };
}

// ë°ì´í„° í—¬í¼ í•¨ìˆ˜ë“¤
function getPatientInfo(subjectId) {
  const patient = SAMPLE_PATIENTS.find(p => p.subject_id == subjectId);
  if (patient) {
    return {
      success: true,
      data: {
        name: patient.name,
        gender: patient.gender === 'M' ? 'ë‚¨ì„±' : 'ì—¬ì„±',
        age: patient.anchor_age,
        dob: patient.dob
      }
    };
  }
  return { success: false, message: 'í™˜ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' };
}

function getAdmissionInfo(subjectId, hadmId) {
  const admission = SAMPLE_ADMISSIONS.find(a =>
    a.subject_id == subjectId && a.hadm_id == hadmId
  );
  if (admission) {
    return {
      success: true,
      data: {
        admittime: admission.admittime.split('T')[0] + 'T' + admission.admittime.split('T')[1].substring(0,5),
        dischtime: admission.dischtime ?
          admission.dischtime.split('T')[0] + 'T' + admission.dischtime.split('T')[1].substring(0,5) : null,
        admission_type: admission.admission_type
      }
    };
  }
  return { success: false, message: 'ì…ì› ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' };
}

function getNextSequenceNumber(hadmId) {
  const procedures = EXISTING_PROCEDURES.filter(p => p.hadm_id == hadmId);
  const maxSeq = procedures.length > 0 ? Math.max(...procedures.map(p => p.seq_num)) : 0;
  return {
    success: true,
    data: { nextSeq: maxSeq + 1 }
  };
}

function getPatientList() {
  const patientsWithAdmissions = SAMPLE_PATIENTS.map(patient => {
    const admissions = SAMPLE_ADMISSIONS.filter(a => a.subject_id === patient.subject_id);
    const currentAdmission = admissions.find(a => a.dischtime === null);
    const latestAdmission = admissions.sort((a, b) => new Date(b.admittime) - new Date(a.admittime))[0];

    return {
      subject_id: patient.subject_id,
      name: patient.name,
      gender: patient.gender,
      age: patient.anchor_age,
      dob: patient.dob,
      hadm_id: currentAdmission ? currentAdmission.hadm_id : (latestAdmission ? latestAdmission.hadm_id : null),
      admittime: currentAdmission ? currentAdmission.admittime : (latestAdmission ? latestAdmission.admittime : null),
      dischtime: currentAdmission ? null : (latestAdmission ? latestAdmission.dischtime : null),
      status: currentAdmission ? 'ì…ì›ì¤‘' : 'í‡´ì›'
    };
  });

  return {
    success: true,
    data: patientsWithAdmissions.sort((a, b) => {
      if (a.status === 'ì…ì›ì¤‘' && b.status !== 'ì…ì›ì¤‘') return -1;
      if (a.status !== 'ì…ì›ì¤‘' && b.status === 'ì…ì›ì¤‘') return 1;
      return new Date(b.admittime || '1900-01-01') - new Date(a.admittime || '1900-01-01');
    }),
    total: patientsWithAdmissions.length
  };
}

// í™˜ì ì •ë³´ ê²€ì¦ ë° ë¡œë“œ
async function validateAndLoadPatientInfo(subjectId) {
  try {
    const response = await mockAPICall(`/api/patient/${subjectId}`);
    if (response.success) {
      document.getElementById('subject_id').classList.add('success');
      document.getElementById('subject_id').classList.remove('error');

      const patientInfo = document.getElementById('patient-info');
      if (patientInfo) {
        patientInfo.innerHTML = `
          <strong>í™˜ìëª…:</strong> ${response.data.name} |
          <strong>ì„±ë³„:</strong> ${response.data.gender} |
          <strong>ë‚˜ì´:</strong> ${response.data.age}ì„¸ |
          <strong>ìƒë…„ì›”ì¼:</strong> ${response.data.dob}
        `;
        patientInfo.style.display = 'block';
      }

      // ğŸ”¥ í™˜ìì˜ ì…ì› ëª©ë¡ì„ ë“œë¡­ë‹¤ìš´ìœ¼ë¡œ í‘œì‹œ
      await loadPatientAdmissions(subjectId);

    } else {
      document.getElementById('subject_id').classList.add('error');
      document.getElementById('subject_id').classList.remove('success');
      const patientInfo = document.getElementById('patient-info');
      if (patientInfo) {
        patientInfo.innerHTML = `<span style="color: #dc3545;">âŒ í™˜ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${subjectId}</span>`;
        patientInfo.style.display = 'block';
      }

      // ì…ì› ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
      resetAdmissionDropdown();
    }
  } catch (error) {
    console.error('í™˜ì ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:', error);
    resetAdmissionDropdown();
  }
}

// ğŸ”¥ í™˜ìì˜ ì…ì› ëª©ë¡ ë¡œë“œ ë° ë“œë¡­ë‹¤ìš´ ìƒì„± (ê°•í™”ë¨)
async function loadPatientAdmissions(subjectId) {
  const patientAdmissions = SAMPLE_ADMISSIONS.filter(adm => adm.subject_id == subjectId);

  if (patientAdmissions.length === 0) {
    showAdmissionMessage('ì´ í™˜ìì˜ ì…ì› ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }

  // ìµœì‹  ì…ì› ìˆœìœ¼ë¡œ ì •ë ¬
  patientAdmissions.sort((a, b) => new Date(b.admittime) - new Date(a.admittime));

  // ì…ì› ID í•„ë“œë¥¼ ë“œë¡­ë‹¤ìš´ìœ¼ë¡œ ë³€ê²½
  const hadmIdInput = document.getElementById('hadm_id');
  if (hadmIdInput) {
    // ğŸ”¥ ì´ë¯¸ ê°’ì´ ì…ë ¥ë˜ì–´ ìˆë‹¤ë©´ ê·¸ ê°’ì„ ìœ ì§€
    const currentHadmId = hadmIdInput.value.trim();

    // ê¸°ì¡´ ì…ë ¥ í•„ë“œë¥¼ ìˆ¨ê¸°ê³  ë“œë¡­ë‹¤ìš´ ìƒì„±
    hadmIdInput.style.display = 'none';

    let dropdown = document.getElementById('hadm_id_dropdown');
    if (!dropdown) {
      dropdown = document.createElement('select');
      dropdown.id = 'hadm_id_dropdown';
      dropdown.style.cssText = hadmIdInput.style.cssText;
      dropdown.addEventListener('change', function() {
        hadmIdInput.value = this.value;
        if (this.value) {
          validateAndLoadAdmissionInfo(subjectId, this.value);
          calculateNextSeqNum(this.value);
        }
      });
      hadmIdInput.parentNode.insertBefore(dropdown, hadmIdInput.nextSibling);
    }

    // ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ìƒì„±
    dropdown.innerHTML = '<option value="">ì…ì›ì„ ì„ íƒí•˜ì„¸ìš”</option>';
    patientAdmissions.forEach(adm => {
      const admitDate = new Date(adm.admittime).toLocaleDateString();
      const status = adm.dischtime ? 'í‡´ì›' : 'ì…ì›ì¤‘';
      const statusIcon = adm.dischtime ? 'âœ…' : 'ğŸ¥';

      dropdown.innerHTML += `
        <option value="${adm.hadm_id}">
          ${adm.hadm_id} - ${admitDate} (${status}) ${statusIcon}
        </option>
      `;
    });

    dropdown.style.display = 'block';

    // ğŸ”¥ ê¸°ì¡´ì— ì…ë ¥ëœ ê°’ì´ ìˆë‹¤ë©´ ê·¸ ê°’ìœ¼ë¡œ ì„¤ì •
    if (currentHadmId) {
      const existingOption = dropdown.querySelector(`option[value="${currentHadmId}"]`);
      if (existingOption) {
        dropdown.value = currentHadmId;
        await validateAndLoadAdmissionInfo(subjectId, currentHadmId);
        await calculateNextSeqNum(currentHadmId);
      }
    } else {
      // ê°€ì¥ ìµœê·¼ ì…ì›ì„ ìë™ ì„ íƒ
      if (patientAdmissions.length > 0) {
        const latestAdmission = patientAdmissions[0];
        dropdown.value = latestAdmission.hadm_id;
        hadmIdInput.value = latestAdmission.hadm_id;

        // ìë™ìœ¼ë¡œ ì…ì› ì •ë³´ ë¡œë“œ
        await validateAndLoadAdmissionInfo(subjectId, latestAdmission.hadm_id);
        await calculateNextSeqNum(latestAdmission.hadm_id);
      }
    }
  }
}

// === ğŸ”¥ ì €ì¥ ë²„íŠ¼ ìƒíƒœ ê´€ë¦¬ í•¨ìˆ˜ (ë¨¼ì € ì •ì˜) ===
function updateSaveButtonState(canSave, hasWarnings, message) {
  const saveBtn = document.getElementById('save-procedure');
  const statusDiv = document.getElementById('save-status');

  if (!saveBtn) return;

  // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ ì˜ì—­ ìƒì„± (ì—†ìœ¼ë©´)
  if (!statusDiv) {
    const newStatusDiv = document.createElement('div');
    newStatusDiv.id = 'save-status';
    newStatusDiv.style.cssText = `
      margin-top: 8px;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.9em;
      font-weight: 500;
      text-align: center;
    `;
    saveBtn.parentNode.insertBefore(newStatusDiv, saveBtn.nextSibling);
  }

  const statusElement = document.getElementById('save-status');

  if (!canSave) {
    // ì˜¤ë¥˜ ìƒíƒœ: ì €ì¥ ë¶ˆê°€
    saveBtn.disabled = true;
    saveBtn.style.background = '#dc3545';
    saveBtn.style.opacity = '0.6';
    saveBtn.style.cursor = 'not-allowed';
    saveBtn.textContent = 'ì €ì¥ ë¶ˆê°€';

    statusElement.style.background = '#f8d7da';
    statusElement.style.color = '#721c24';
    statusElement.style.border = '1px solid #f5c6cb';
    statusElement.innerHTML = `âŒ ${message}`;

  } else if (hasWarnings) {
    // ê²½ê³  ìƒíƒœ: ì €ì¥ ê°€ëŠ¥í•˜ë‚˜ í™•ì¸ í•„ìš”
    saveBtn.disabled = false;
    saveBtn.style.background = '#ffc107';
    saveBtn.style.opacity = '1';
    saveBtn.style.cursor = 'pointer';
    saveBtn.style.color = '#212529';
    saveBtn.textContent = 'í™•ì¸ í›„ ì €ì¥';

    statusElement.style.background = '#fff3cd';
    statusElement.style.color = '#856404';
    statusElement.style.border = '1px solid #ffeaa7';
    statusElement.innerHTML = `âš ï¸ ${message}`;

  } else {
    // ì •ìƒ ìƒíƒœ: ì €ì¥ ê°€ëŠ¥
    saveBtn.disabled = false;
    saveBtn.style.background = '#28a745';
    saveBtn.style.opacity = '1';
    saveBtn.style.cursor = 'pointer';
    saveBtn.style.color = 'white';
    saveBtn.textContent = 'ì €ì¥';

    statusElement.style.background = '#d4edda';
    statusElement.style.color = '#155724';
    statusElement.style.border = '1px solid #c3e6cb';
    statusElement.innerHTML = `âœ… ${message}`;
  }
}


async function validateAndLoadPatientInfo(subjectId) {
  try {
    const response = await mockAPICall(`/api/patient/${subjectId}`);
    if (response.success) {
      document.getElementById('subject_id').classList.add('success');
      document.getElementById('subject_id').classList.remove('error');

      const patientInfo = document.getElementById('patient-info');
      if (patientInfo) {
        patientInfo.innerHTML = `
          <strong>í™˜ìëª…:</strong> ${response.data.name} |
          <strong>ì„±ë³„:</strong> ${response.data.gender} |
          <strong>ë‚˜ì´:</strong> ${response.data.age}ì„¸ |
          <strong>ìƒë…„ì›”ì¼:</strong> ${response.data.dob}
        `;
        patientInfo.style.display = 'block';
      }

      // ğŸ”¥ í™˜ìì˜ ì…ì› ëª©ë¡ì„ ë“œë¡­ë‹¤ìš´ìœ¼ë¡œ í‘œì‹œ
      await loadPatientAdmissions(subjectId);

    } else {
      document.getElementById('subject_id').classList.add('error');
      document.getElementById('subject_id').classList.remove('success');
      const patientInfo = document.getElementById('patient-info');
      if (patientInfo) {
        patientInfo.innerHTML = `<span style="color: #dc3545;">âŒ í™˜ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${subjectId}</span>`;
        patientInfo.style.display = 'block';
      }

      // ì…ì› ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
      resetAdmissionDropdown();
    }
  } catch (error) {
    console.error('í™˜ì ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:', error);
    resetAdmissionDropdown();
  }
}

async function validateAndLoadAdmissionInfo(subjectId, hadmId) {
  try {
    // ì…ì› IDë¡œ í™˜ì ID ì°¾ê¸° (ì…ì› IDë§Œ ì…ë ¥ëœ ê²½ìš°)
    if (!subjectId) {
      const admission = SAMPLE_ADMISSIONS.find(adm => adm.hadm_id == hadmId);
      if (admission) {
        document.getElementById('subject_id').value = admission.subject_id;
        await validateAndLoadPatientInfo(admission.subject_id);
        return;
      }
    }

    const response = await mockAPICall(`/api/admission/${subjectId}/${hadmId}`);
    if (response.success) {
      document.getElementById('hadm_id').classList.add('success');
      document.getElementById('hadm_id').classList.remove('error');

      const admissionInfo = document.getElementById('admission-info');
      if (admissionInfo) {
        const admitDate = new Date(response.data.admittime).toLocaleDateString();
        const dischargeInfo = response.data.dischtime ?
          `í‡´ì›ì¼: ${new Date(response.data.dischtime).toLocaleDateString()}` :
          '<span style="color: #28a745; font-weight: 600;">í˜„ì¬ ì…ì›ì¤‘ ğŸ¥</span>';

        admissionInfo.innerHTML = `
          <strong>ì…ì›ì¼:</strong> ${admitDate} |
          <strong>${dischargeInfo}</strong> |
          <strong>ì…ì› ìœ í˜•:</strong> ${response.data.admission_type}
        `;
        admissionInfo.style.display = 'block';
      }

      // ğŸ”¥ ì´ í™˜ìì˜ ê¸°ì¡´ ì‹œìˆ  ëª©ë¡ë„ í‘œì‹œ
      showExistingProcedures(subjectId, hadmId);

    } else {
      document.getElementById('hadm_id').classList.add('error');
      document.getElementById('hadm_id').classList.remove('success');
      const admissionInfo = document.getElementById('admission-info');
      if (admissionInfo) admissionInfo.style.display = 'none';
    }
  } catch (error) {
    console.error('ì…ì› ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:', error);
  }
}

// ğŸ”¥ ê¸°ì¡´ ì‹œìˆ  ëª©ë¡ í‘œì‹œ (ì°¸ê³ ìš©)
function showExistingProcedures(subjectId, hadmId) {
  const existingProcs = EXISTING_PROCEDURES.filter(proc =>
    proc.subject_id == subjectId && proc.hadm_id == hadmId
  );

  const container = document.getElementById('admission-info');
  if (container && existingProcs.length > 0) {
    let procHtml = '<div style="margin-top: 12px; padding: 8px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #17a2b8;">';
    procHtml += '<strong style="color: #17a2b8;">ğŸ” ê¸°ì¡´ ì‹œìˆ  ì´ë ¥:</strong><br>';

    existingProcs.forEach((proc, index) => {
      const procDate = new Date(proc.chartdate).toLocaleDateString();
      procHtml += `<span style="font-size: 0.9em; color: #495057;">
        ${index + 1}. ${proc.icd_code} - ${proc.long_title} (${procDate})
      </span><br>`;
    });

    procHtml += '</div>';
    container.innerHTML += procHtml;
  }
}

async function calculateNextSeqNum(hadmId) {
  try {
    const response = await mockAPICall(`/api/procedure/next-seq/${hadmId}`);
    if (response.success) {
      const seqInput = document.getElementById('seq_num');
      if (seqInput) seqInput.value = response.data.nextSeq;
    }
  } catch (error) {
    console.error('ìˆœë²ˆ ê³„ì‚° ì˜¤ë¥˜:', error);
  }
}

// ICD ì½”ë“œ ê²€ì¦
function validateICDCode() {
  const icdCodeInput = document.getElementById('icd_code');
  if (!icdCodeInput) return false;

  const icdVersionRadio = document.querySelector('input[name="icd_version"]:checked');
  if (!icdVersionRadio) return false;

  const icdVersion = icdVersionRadio.value;
  const code = icdCodeInput.value.trim().toUpperCase();

  if (!code) return false;

  let isValid = false;
  if (icdVersion === '9') {
    isValid = /^\d{3,5}$/.test(code);
  } else if (icdVersion === '10') {
    isValid = /^[A-Z0-9]\w{2,6}$/.test(code);
  }

  if (isValid) {
    icdCodeInput.classList.remove('error');
    icdCodeInput.classList.add('success');
    return true;
  } else {
    icdCodeInput.classList.add('error');
    icdCodeInput.classList.remove('success');
    return false;
  }
}

// ICD ìë™ì™„ì„±
function setupICDAutoComplete() {
  const icdInput = document.getElementById('icd_code');
  const suggestionsDiv = document.getElementById('icd-suggestions');

  if (icdInput) {
    icdInput.addEventListener('input', function() {
      const query = this.value.trim();
      if (query.length >= 2) {
        showICDSuggestions(query);
      } else {
        hideSuggestions();
        clearProcedureName();
      }

      // ğŸ”¥ íƒ€ì´í•‘ ì¤‘ì—ë„ ì‹¤ì‹œê°„ìœ¼ë¡œ ì‹œìˆ ëª… ì°¾ê¸°
      if (query.length >= 3) {
        findAndDisplayProcedureName(query);
      }
    });

    icdInput.addEventListener('blur', function() {
      setTimeout(() => {
        hideSuggestions();
        // ğŸ”¥ í¬ì»¤ìŠ¤ ìƒì„ ë•Œë„ ì‹œìˆ ëª… í™•ì¸
        const code = this.value.trim();
        if (code) {
          findAndDisplayProcedureName(code);
        }
      }, 200);
    });
  }
}

// ğŸ”¥ ICD ì½”ë“œë¡œ ì‹œìˆ ëª… ì°¾ê¸° ë° í‘œì‹œ
function findAndDisplayProcedureName(icdCode) {
  const icdVersionRadio = document.querySelector('input[name="icd_version"]:checked');
  if (!icdVersionRadio) return;

  const version = icdVersionRadio.value;
  const matchingICD = VALID_ICD_CODES.find(item =>
    item.code.toLowerCase() === icdCode.toLowerCase() && item.version === version
  );

  const titleInput = document.getElementById('long_title');
  if (titleInput) {
    if (matchingICD) {
      titleInput.value = matchingICD.title;
      titleInput.style.color = '#28a745';
      titleInput.style.fontWeight = '600';

      // ğŸ”¥ ICD ì…ë ¥ í•„ë“œì—ë„ ì‹œìˆ ëª… íŒíŠ¸ í‘œì‹œ
      showICDNameHint(icdCode, matchingICD.title);

    } else {
      titleInput.value = '';
      titleInput.style.color = '#6c757d';
      titleInput.style.fontWeight = 'normal';

      // ì˜ëª»ëœ ì½”ë“œ íŒíŠ¸
      if (icdCode.length >= 3) {
<!--        showICDNameHint(icdCode, 'âŒ ì˜¬ë°”ë¥´ì§€ ì•Šì€ ICD ì½”ë“œ');-->
      }
    }
  }
}

// ğŸ”¥ ICD ì½”ë“œ ì˜†ì— ì‹œìˆ ëª… íŒíŠ¸ í‘œì‹œ
function showICDNameHint(code, title) {
  let hintDiv = document.getElementById('icd-name-hint');
  if (!hintDiv) {
    hintDiv = document.createElement('div');
    hintDiv.id = 'icd-name-hint';
    hintDiv.style.cssText = `
      margin-top: 4px;
      padding: 6px 10px;
      background: #e7f3ff;
      border: 1px solid #b3d7ff;
      border-radius: 6px;
      font-size: 0.9em;
      color: #0066cc;
      font-weight: 500;
    `;

    const icdInput = document.getElementById('icd_code');
    if (icdInput && icdInput.parentNode) {
      icdInput.parentNode.appendChild(hintDiv);
    }
  }

  if (title.includes('âŒ')) {
    hintDiv.style.background = '#ffebee';
    hintDiv.style.borderColor = '#f5c6cb';
    hintDiv.style.color = '#721c24';
  } else {
    hintDiv.style.background = '#e7f3ff';
    hintDiv.style.borderColor = '#b3d7ff';
    hintDiv.style.color = '#0066cc';
  }

  hintDiv.innerHTML = `<strong>${code}</strong> â†’ ${title}`;
}

// ğŸ”¥ ì‹œìˆ ëª… í‘œì‹œ ê°•í™”ëœ ìë™ì™„ì„±
function showICDSuggestions(query) {
  const suggestionsDiv = document.getElementById('icd-suggestions');
  if (!suggestionsDiv) return;

  const icdVersionRadio = document.querySelector('input[name="icd_version"]:checked');
  if (!icdVersionRadio) return;

  const icdVersion = icdVersionRadio.value;

  const suggestions = VALID_ICD_CODES.filter(item =>
    item.version === icdVersion &&
    (item.code.toLowerCase().includes(query.toLowerCase()) ||
     item.title.toLowerCase().includes(query.toLowerCase()))
  ).slice(0, 8);

  if (suggestions.length > 0) {
    suggestionsDiv.innerHTML = suggestions.map(item => `
      <div class="suggestion-item" onclick="window.selectICDCode('${item.code}', '${item.title}')" style="padding: 12px 14px; cursor: pointer; border-bottom: 1px solid #f1f3f5; transition: background 0.2s;">
        <div style="font-weight: 600; color: #3A86FF; font-size: 1.1em;">${item.code}</div>
        <div style="font-size: 0.95em; color: #495057; margin-top: 2px; line-height: 1.4;">${item.title}</div>
        <div style="font-size: 0.8em; color: #6c757d; margin-top: 4px;">
          <span style="background: #f8f9fa; padding: 2px 6px; border-radius: 4px;">${item.category}</span>
          <span style="margin-left: 8px;">ICD-${item.version}</span>
        </div>
      </div>
    `).join('');
    suggestionsDiv.style.display = 'block';
  } else {
    hideSuggestions();
  }
}

function showICDSuggestions(query) {
  const suggestionsDiv = document.getElementById('icd-suggestions');
  if (!suggestionsDiv) return;

  const icdVersionRadio = document.querySelector('input[name="icd_version"]:checked');
  if (!icdVersionRadio) return;

  const icdVersion = icdVersionRadio.value;

  const suggestions = VALID_ICD_CODES.filter(item =>
    item.version === icdVersion &&
    (item.code.toLowerCase().includes(query.toLowerCase()) ||
     item.title.toLowerCase().includes(query.toLowerCase()))
  ).slice(0, 10);

  if (suggestions.length > 0) {
    suggestionsDiv.innerHTML = suggestions.map(item => `
      <div class="suggestion-item" onclick="window.selectICDCode('${item.code}', '${item.title}')">
        <div style="font-weight: 600; color: #3A86FF;">${item.code}</div>
        <div style="font-size: 0.9em; color: #6c757d;">${item.title}</div>
      </div>
    `).join('');
    suggestionsDiv.style.display = 'block';
  } else {
    hideSuggestions();
  }
}

function hideSuggestions() {
  const suggestionsDiv = document.getElementById('icd-suggestions');
  if (suggestionsDiv) {
    suggestionsDiv.style.display = 'none';
  }
}

// í™˜ì ëª©ë¡ ê´€ë¦¬
async function loadPatientList() {
  try {
    const directResult = getPatientList();
    if (directResult.success && directResult.data.length > 0) {
      currentPatientData = directResult.data.sort((a, b) => {
        const dateA = new Date(a.admittime || '1900-01-01');
        const dateB = new Date(b.admittime || '1900-01-01');
        return dateB - dateA;
      });
      totalPatients = directResult.total || directResult.data.length;
      currentPage = 1;
      renderPatientTable();
      renderPagination();
    }
  } catch (error) {
    console.error('âŒ í™˜ì ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
  }
}

function renderPatientTable() {
  const tbody = document.getElementById('patient-table-body');
  if (!tbody) return;

  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const pageData = currentPatientData.slice(startIndex, endIndex);

  if (pageData.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="10" style="text-align: center; padding: 40px; color: #6c757d;">
          ê²€ìƒ‰ ì¡°ê±´ì— ë§ëŠ” í™˜ìê°€ ì—†ìŠµë‹ˆë‹¤.
        </td>
      </tr>
    `;
    return;
  }

  tbody.innerHTML = pageData.map((patient, index) => {
    const admitDate = new Date(patient.admittime || '1900-01-01');
    const daysDiff = Math.floor((new Date() - admitDate) / (1000 * 60 * 60 * 24));
    let dateStyle = '';
    let statusIcon = '';

    if (patient.status === 'ì…ì›ì¤‘') {
      if (daysDiff <= 1) {
        dateStyle = 'background: #d4edda; color: #155724; font-weight: 600;';
        statusIcon = 'ğŸ†•';
      } else if (daysDiff <= 7) {
        dateStyle = 'background: #fff3cd; color: #856404; font-weight: 500;';
        statusIcon = 'ğŸ“…';
      } else {
        statusIcon = 'ğŸ¥';
      }
    } else {
      statusIcon = 'âœ…';
    }

    return `
      <tr class="patient-row" data-patient-id="${patient.subject_id}" onmouseover="showPatientTooltip(event, ${patient.subject_id})" onmouseout="hidePatientTooltip()">
        <td style="font-weight: 600; color: #3A86FF;">${patient.subject_id}</td>
        <td style="font-weight: 500; cursor: pointer;" ondblclick="selectPatient(${patient.subject_id})">${patient.name}</td>
        <td>${patient.gender === 'M' ? 'ë‚¨ì„±' : 'ì—¬ì„±'}</td>
        <td>${patient.age}ì„¸</td>
        <td>${patient.dob}</td>
        <td>${patient.hadm_id || '-'}</td>
        <td style="${dateStyle}">${patient.admittime ? new Date(patient.admittime).toLocaleDateString() + (daysDiff <= 7 && patient.status === 'ì…ì›ì¤‘' ? ` (${daysDiff}ì¼ì „)` : '') : '-'}</td>
        <td>${patient.dischtime ? new Date(patient.dischtime).toLocaleDateString() : '-'}</td>
        <td>
          <span style="padding: 4px 8px; font-size: 0.8em; border-radius: 12px; ${patient.status === 'ì…ì›ì¤‘' ? 'background: #d4edda; color: #155724;' : 'background: #f8d7da; color: #721c24;'}">
            ${statusIcon} ${patient.status}
          </span>
        </td>
        <td>
          <button onclick="selectPatient(${patient.subject_id})" style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; cursor: pointer;">
            ì„ íƒ
          </button>
        </td>
      </tr>
    `;
  }).join('');
}

function renderPagination() {
  // ê°„ë‹¨í•œ í˜ì´ì§€ë„¤ì´ì…˜ êµ¬í˜„
  const paginationDiv = document.getElementById('patient-pagination');
  if (!paginationDiv) return;

  const totalPages = Math.ceil(totalPatients / itemsPerPage);
  if (totalPages <= 1) {
    paginationDiv.innerHTML = '';
    return;
  }

  let html = '';
  for (let i = 1; i <= totalPages; i++) {
    html += `<button onclick="changePage(${i})" ${i === currentPage ? 'style="background: #3A86FF; color: white;"' : ''}>${i}</button>`;
  }
  paginationDiv.innerHTML = html;
}

function setupPatientListEvents() {
  // í™˜ì ëª©ë¡ ê´€ë ¨ ì´ë²¤íŠ¸ ì„¤ì • (ê°„ëµí™”)
}

function setupEventHandlers() {
  // ê¸°ë³¸ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì„¤ì • (ê°„ëµí™”)
}

// ì „ì—­ í•¨ìˆ˜ë“¤ ìµœì¢… ë“±ë¡
window.showPatientTooltip = function(event, subjectId) { /* êµ¬í˜„ ìƒëµ */ };
window.hidePatientTooltip = function() { /* êµ¬í˜„ ìƒëµ */ };
window.selectPatient = function(subjectId) {
  const patient = currentPatientData.find(p => p.subject_id === subjectId);
  if (!patient) return;

  selectedPatient = patient;
  document.getElementById('subject_id').value = patient.subject_id;
  document.getElementById('hadm_id').value = patient.hadm_id || '';

  document.querySelector('[data-tab="tab-procedure-input"]').click();

  if (patient.subject_id) validateAndLoadPatientInfo(patient.subject_id);
  if (patient.hadm_id) {
    validateAndLoadAdmissionInfo(patient.subject_id, patient.hadm_id);
    calculateNextSeqNum(patient.hadm_id);
  }
};
window.changePage = function(page) {
  if (page < 1 || page > Math.ceil(totalPatients / itemsPerPage)) return;
  currentPage = page;
  renderPatientTable();
  renderPagination();
};

console.log('ğŸ‰ tab3 ëª¨ë“  ê¸°ëŠ¥ ë¡œë“œ ì™„ë£Œ!');

</script>