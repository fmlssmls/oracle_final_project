<!-- tab0.html -->
<style>
/* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
.ecrf-tab-btn {
  background: none;
  border: 1.5px solid transparent;
  color: #3A86FF;
  font-weight: 600;
  font-size: 1em;
  padding: 12px 20px;
  cursor: pointer;
  transition: background-color 0.2s, color 0.2s, border-color 0.2s;
  border-radius: 8px;
  margin: 4px 8px 4px 0;
  text-align: left;
  width: 100%;
  box-sizing: border-box;
}

.ecrf-tab-btn:hover {
  background-color: #F1F3F5;
  color: #0056b3;
}

.ecrf-tab-btn.active {
  background-color: #3A86FF;
  color: white;
  border-color: #3A86FF;
}

.ecrf-form-table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 20px;
  font-size: 0.95em;
}

.ecrf-form-table td {
  padding: 12px 15px;
  border-bottom: 1px solid #E9ECEF;
  vertical-align: top;
}

.ecrf-form-table td:first-child {
  background: #F8F9FA;
  font-weight: 600;
  width: 150px;
  color: #495057;
}

/* 3ì—´ ì²´í¬ë°•ìŠ¤ ê·¸ë£¹ ìŠ¤íƒ€ì¼ */
.column-checkbox-group {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px 20px;
  align-items: start;
}

.column-checkbox-group label {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.9em;
  color: #495057;
  cursor: pointer;
  padding: 4px 0;
  line-height: 1.4;
}

.column-checkbox-group input[type="checkbox"] {
  margin: 0;
  flex-shrink: 0;
}

.ecrf-save-btn {
  background: #3A86FF;
  color: white;
  padding: 10px 20px;
  border: none;
  font-weight: bold;
  border-radius: 8px;
  cursor: pointer;
  font-size: 1.05em;
}

.ecrf-save-btn:hover {
  background: #0056b3;
}

h2 {
  margin-bottom: 24px;
  color: #343A40;
  border-bottom: 2px solid #DEE2E6;
  padding-bottom: 10px;
}

h3 {
  margin-top: 30px;
  margin-bottom: 10px;
  color: #3A86FF;
  font-size: 1.2em;
  border-left: 4px solid #3A86FF;
  padding-left: 10px;
}

/* ì±—ë´‡ ìŠ¤íƒ€ì¼ */
#tab-chatbot-area {
  height: calc(100vh - 200px);
  display: flex;
  flex-direction: column;
}

#tab-chatbot-messages {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 12px;
  margin-bottom: 20px;
  min-height: 400px;
}

#tab-chatbot-input-area {
  display: flex;
  gap: 12px;
  align-items: center;
}

#tab-chatbot-input {
  flex: 1;
  padding: 12px 16px;
  border: 1.5px solid #dee2e6;
  border-radius: 24px;
  font-size: 1em;
  outline: none;
  transition: border-color 0.2s;
}

#tab-chatbot-input:focus {
  border-color: #3A86FF;
}

#tab-chatbot-send {
  background: #3A86FF !important;
  color: white !important;
  border: none !important;
  padding: 12px 24px !important;
  border-radius: 20px !important;
  cursor: pointer !important;
  font-weight: 600 !important;
  transition: background-color 0.2s !important;
  z-index: 999999 !important;
  position: relative !important;
  pointer-events: auto !important;
}

#tab-chatbot-send:hover {
  background: #0056b3 !important;
}

/* ì±„íŒ… ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
.chat-message {
  margin-bottom: 15px;
  display: flex;
  flex-direction: column;
}

.chat-message.user {
  align-items: flex-end;
}

.chat-message.ai {
  align-items: flex-start;
}

.message-content {
  max-width: 70%;
  padding: 12px 16px;
  border-radius: 12px;
  word-wrap: break-word;
  font-size: 0.95em;
}

.chat-message.user .message-content {
  background: #3A86FF;
  color: white;
  border-bottom-right-radius: 4px;
}

.chat-message.ai .message-content {
  background: #e9ecef;
  color: #343A40;
  border-bottom-left-radius: 4px;
}

/* ë²„íŠ¼ ìœ„ì¹˜ ìˆ˜ì • */
#reset-settings-btn {
  position: fixed !important;
  bottom: 70px !important;
  left: 300px !important;
  z-index: 99999 !important;
  width: auto !important;
  height: 35px !important;
  padding: 8px 12px !important;
  background: #6C757D !important;
  color: white !important;
  border: none !important;
  border-radius: 6px !important;
  cursor: pointer !important;
  font-size: 13px !important;
  pointer-events: auto !important;
}

#save-settings-btn {
  position: fixed !important;
  bottom: 70px !important;
  left: 400px !important;
  z-index: 99999 !important;
  width: auto !important;
  height: 35px !important;
  padding: 8px 12px !important;
  background: #3A86FF !important;
  color: white !important;
  border: none !important;
  border-radius: 6px !important;
  cursor: pointer !important;
  font-size: 13px !important;
  pointer-events: auto !important;
}

#apply-settings-btn {
  position: fixed !important;
  bottom: 70px !important;
  left: 480px !important;
  z-index: 99999 !important;
  width: auto !important;
  height: 35px !important;
  padding: 8px 12px !important;
  background: #0069D9 !important;
  color: white !important;
  border: none !important;
  border-radius: 6px !important;
  cursor: pointer !important;
  font-size: 13px !important;
  pointer-events: auto !important;
}
</style>

<div id="ecrf-wrap" style="display: flex; height: 100%; font-family: 'Noto Sans KR', sans-serif;">
  <!-- ì¢Œì¸¡ ë„¤ë¹„ê²Œì´ì…˜ -->
  <aside style="width: 240px; background: #f8f9fa; border-right: 1.5px solid #dee2e6; padding: 20px 0;">
    <nav style="display: flex; flex-direction: column; gap: 8px;">
      <button class="ecrf-tab-btn" data-tab="tab-column-settings">ì»¬ëŸ¼ ì„¤ì •</button>
      <button class="ecrf-tab-btn" data-tab="tab-chatbot">ì±—ë´‡</button>
    </nav>
  </aside>

  <!-- ìš°ì¸¡ ì½˜í…ì¸  -->
  <main style="flex: 1; padding: 32px; overflow-y: auto; background: #fff;">

    <!-- tab0.htmlì˜ ì»¬ëŸ¼ ì„¤ì • ì„¹ì…˜ - í”„ë¦¬ì…‹ ê¸°ëŠ¥ ì¶”ê°€ ë²„ì „ -->

    <section id="tab-column-settings" class="ecrf-tab-content">
      <h2>ì»¬ëŸ¼ ì„¤ì •</h2>

      <!-- í”„ë¦¬ì…‹ ì„ íƒ ì˜ì—­ -->
      <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px; border: 1px solid #dee2e6;">
        <h4 style="margin: 0 0 15px 0; color: #495057;">ì„¤ì • í”„ë¦¬ì…‹</h4>
        <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
          <label style="font-weight: 500; color: #495057;">í”„ë¦¬ì…‹ ì„ íƒ:</label>
          <select id="preset-selector" style="padding: 8px 12px; border: 1px solid #ced4da; border-radius: 6px; background: white; min-width: 200px;">
            <option value="">ì‚¬ìš©ì ì •ì˜</option>
            <option value="basic">ê¸°ë³¸ ì„¤ì • (í™˜ìID, ì„±ë³„, ë‚˜ì´)</option>
            <option value="detailed">ìƒì„¸ ë¶„ì„ (ëª¨ë“  ì£¼ìš” ì»¬ëŸ¼)</option>
            <option value="simple">ê°„ë‹¨ ì¡°íšŒ (ìµœì†Œ ì»¬ëŸ¼)</option>
            <option value="research">ì—°êµ¬ìš© (ì„ìƒì‹œí—˜ ì¤‘ì‹¬)</option>
          </select>
          <button id="save-as-preset-btn" style="background: #28a745; color: white; padding: 8px 16px; border: none; border-radius: 6px; font-size: 0.9em; cursor: pointer;">í˜„ì¬ ì„¤ì •ì„ í”„ë¦¬ì…‹ìœ¼ë¡œ ì €ì¥</button>
        </div>
      </div>

      <div id="column-settings-content">

        <!-- 1. í™˜ì/ì…ì› ì„¤ì • -->
        <h3>í™˜ì/ì…ì› ë¶„ì„</h3>
        <table class="ecrf-form-table">
          <tr><td>í™˜ì ê¸°ë³¸ì •ë³´</td><td class="column-checkbox-group">
            <label><input type="checkbox" name="í™˜ì/ì…ì›" value="subject_id" /> SUBJECT_ID (í™˜ìID) </label>
            <label><input type="checkbox" name="í™˜ì/ì…ì›" value="gender"  /> GENDER (ì„±ë³„) </label>
            <label><input type="checkbox" name="í™˜ì/ì…ì›" value="anchor_age" /> ANCHOR_AGE (ë‚˜ì´) </label>
            <label><input type="checkbox" name="í™˜ì/ì…ì›" value="dod" /> DOD (ì‚¬ë§ì¼)</label>
            <label><input type="checkbox" name="í™˜ì/ì…ì›" value="anchor_year" /> ANCHOR_YEAR (ê¸°ì¤€ë…„ë„)</label>
            <label><input type="checkbox" name="í™˜ì/ì…ì›" value="anchor_year_group" /> ANCHOR_YEAR_GROUP (ì—°ë„ê·¸ë£¹)</label>
          </td></tr>
          <tr><td>ì…ì›ì •ë³´</td><td class="column-checkbox-group">
            <label><input type="checkbox" name="í™˜ì/ì…ì›" value="hadm_id" /> HADM_ID (ì…ì›ID)</label>
            <label><input type="checkbox" name="í™˜ì/ì…ì›" value="admittime" /> ADMITTIME (ì…ì›ì‹œê°)</label>
            <label><input type="checkbox" name="í™˜ì/ì…ì›" value="dischtime" /> DISCHTIME (í‡´ì›ì‹œê°)</label>
            <label><input type="checkbox" name="í™˜ì/ì…ì›" value="admission_type" /> ADMISSION_TYPE (ì…ì›ìœ í˜•)</label>
            <label><input type="checkbox" name="í™˜ì/ì…ì›" value="discharge_location" /> DISCHARGE_LOCATION (í‡´ì›ìœ„ì¹˜)</label>
            <label><input type="checkbox" name="í™˜ì/ì…ì›" value="insurance" /> INSURANCE (ë³´í—˜ìœ í˜•)</label>
          </td></tr>
          <tr><td>ICUì •ë³´</td><td class="column-checkbox-group">
            <label><input type="checkbox" name="í™˜ì/ì…ì›" value="stay_id" /> STAY_ID (ICUì…ì›ID)</label>
            <label><input type="checkbox" name="í™˜ì/ì…ì›" value="intime" /> INTIME (ì…ì‹¤ì‹œê°)</label>
            <label><input type="checkbox" name="í™˜ì/ì…ì›" value="outtime" /> OUTTIME (í‡´ì‹¤ì‹œê°)</label>
            <label><input type="checkbox" name="í™˜ì/ì…ì›" value="los" /> LOS (ì¬ì›ê¸°ê°„)</label>
            <label><input type="checkbox" name="í™˜ì/ì…ì›" value="first_careunit" /> FIRST_CAREUNIT (ìµœì´ˆICU)</label>
            <label><input type="checkbox" name="í™˜ì/ì…ì›" value="last_careunit" /> LAST_CAREUNIT (ìµœì¢…ICU)</label>
          </td></tr>
        </table>

        <!-- 2. ê²€ì‚¬/ë°”ì´íƒˆ ì„¤ì • -->
        <h3>ê²€ì‚¬/ë°”ì´íƒˆ ë¶„ì„</h3>
        <table class="ecrf-form-table">
          <tr><td>ê²€ì‚¬ ê¸°ë³¸ì •ë³´</td><td class="column-checkbox-group">
            <label><input type="checkbox" name="ê²€ì‚¬/ë°”ì´íƒˆ" value="subject_id" /> SUBJECT_ID (í™˜ìID) </label>
            <label><input type="checkbox" name="ê²€ì‚¬/ë°”ì´íƒˆ" value="hadm_id" /> HADM_ID (ì…ì›ID) </label>
            <label><input type="checkbox" name="ê²€ì‚¬/ë°”ì´íƒˆ" value="itemid"  /> ITEMID (í•­ëª©ID) </label>
            <label><input type="checkbox" name="ê²€ì‚¬/ë°”ì´íƒˆ" value="charttime" /> CHARTTIME (ì¸¡ì •ì‹œê°) </label>
            <label><input type="checkbox" name="ê²€ì‚¬/ë°”ì´íƒˆ" value="value"  /> VALUE (ê°’) </label>
            <label><input type="checkbox" name="ê²€ì‚¬/ë°”ì´íƒˆ" value="label" /> LABEL (í•­ëª©ëª…)</label>
          </td></tr>
          <tr><td>ì¸¡ì •ê°’ ìƒì„¸</td><td class="column-checkbox-group">
            <label><input type="checkbox" name="ê²€ì‚¬/ë°”ì´íƒˆ" value="valuenum" /> VALUENUM (ìˆ˜ì¹˜ê°’)</label>
            <label><input type="checkbox" name="ê²€ì‚¬/ë°”ì´íƒˆ" value="valueuom" /> VALUEUOM (ë‹¨ìœ„)</label>
            <label><input type="checkbox" name="ê²€ì‚¬/ë°”ì´íƒˆ" value="warning" /> WARNING (ê²½ê³ )</label>
            <label><input type="checkbox" name="ê²€ì‚¬/ë°”ì´íƒˆ" value="flag" /> FLAG (í”Œë˜ê·¸)</label>
            <label><input type="checkbox" name="ê²€ì‚¬/ë°”ì´íƒˆ" value="storetime" /> STORETIME (ì €ì¥ì‹œê°)</label>
            <label><input type="checkbox" name="ê²€ì‚¬/ë°”ì´íƒˆ" value="specimen_id" /> SPECIMEN_ID (ê²€ì²´ID)</label>
          </td></tr>
          <tr><td>ë¯¸ìƒë¬¼ê²€ì‚¬</td><td class="column-checkbox-group">
            <label><input type="checkbox" name="ê²€ì‚¬/ë°”ì´íƒˆ" value="test_name" /> TEST_NAME (ê²€ì‚¬ëª…)</label>
            <label><input type="checkbox" name="ê²€ì‚¬/ë°”ì´íƒˆ" value="org_name" /> ORG_NAME (ë¯¸ìƒë¬¼ëª…)</label>
            <label><input type="checkbox" name="ê²€ì‚¬/ë°”ì´íƒˆ" value="ab_name" /> AB_NAME (í•­ìƒì œëª…)</label>
            <label><input type="checkbox" name="ê²€ì‚¬/ë°”ì´íƒˆ" value="interpretation" /> INTERPRETATION (ê²°ê³¼í•´ì„)</label>
            <label><input type="checkbox" name="ê²€ì‚¬/ë°”ì´íƒˆ" value="comments" /> COMMENTS (ë¹„ê³ )</label>
          </td></tr>
        </table>

        <!-- 3. ì§„ë‹¨/ì‹œìˆ  ì„¤ì • -->
        <h3>ì§„ë‹¨/ì‹œìˆ  ë¶„ì„</h3>
        <table class="ecrf-form-table">
          <tr><td>ì§„ë‹¨ ê¸°ë³¸ì •ë³´</td><td class="column-checkbox-group">
            <label><input type="checkbox" name="ì§„ë‹¨/ì‹œìˆ " value="subject_id"/> SUBJECT_ID (í™˜ìID) </label>
            <label><input type="checkbox" name="ì§„ë‹¨/ì‹œìˆ " value="hadm_id" /> HADM_ID (ì…ì›ID) </label>
            <label><input type="checkbox" name="ì§„ë‹¨/ì‹œìˆ " value="icd_code" /> ICD_CODE (ì§„ë‹¨ì½”ë“œ) </label>
            <label><input type="checkbox" name="ì§„ë‹¨/ì‹œìˆ " value="seq_num"  /> SEQ_NUM (ìˆœë²ˆ) </label>
            <label><input type="checkbox" name="ì§„ë‹¨/ì‹œìˆ " value="short_title" /> SHORT_TITLE (ì§„ë‹¨ëª…)</label>
            <label><input type="checkbox" name="ì§„ë‹¨/ì‹œìˆ " value="long_title" /> LONG_TITLE (ìƒì„¸ì§„ë‹¨ëª…)</label>
          </td></tr>
          <tr><td>DRGì •ë³´</td><td class="column-checkbox-group">
            <label><input type="checkbox" name="ì§„ë‹¨/ì‹œìˆ " value="drg_code" /> DRG_CODE (DRGì½”ë“œ)</label>
            <label><input type="checkbox" name="ì§„ë‹¨/ì‹œìˆ " value="drg_type" /> DRG_TYPE (DRGìœ í˜•)</label>
            <label><input type="checkbox" name="ì§„ë‹¨/ì‹œìˆ " value="description" /> DESCRIPTION (ì„¤ëª…)</label>
            <label><input type="checkbox" name="ì§„ë‹¨/ì‹œìˆ " value="drg_severity" /> DRG_SEVERITY (ì¤‘ì¦ë„)</label>
            <label><input type="checkbox" name="ì§„ë‹¨/ì‹œìˆ " value="drg_mortality" /> DRG_MORTALITY (ì‚¬ë§ìœ„í—˜)</label>
            <label><input type="checkbox" name="ì§„ë‹¨/ì‹œìˆ " value="icd_version" /> ICD_VERSION (ICDë²„ì „)</label>
          </td></tr>
        </table>

        <!-- 4. ì•½ë¬¼/íˆ¬ì•½ ì„¤ì • -->
        <h3>ì•½ë¬¼/íˆ¬ì•½ ë¶„ì„</h3>
        <table class="ecrf-form-table">
          <tr><td>ì²˜ë°© ê¸°ë³¸ì •ë³´</td><td class="column-checkbox-group">
            <label><input type="checkbox" name="ì•½ë¬¼/íˆ¬ì•½" value="subject_id"  /> SUBJECT_ID (í™˜ìID) </label>
            <label><input type="checkbox" name="ì•½ë¬¼/íˆ¬ì•½" value="hadm_id"  /> HADM_ID (ì…ì›ID) </label>
            <label><input type="checkbox" name="ì•½ë¬¼/íˆ¬ì•½" value="drug"  /> DRUG (ì•½í’ˆëª…) </label>
            <label><input type="checkbox" name="ì•½ë¬¼/íˆ¬ì•½" value="starttime" /> STARTTIME (ì‹œì‘ì‹œê°) </label>
            <label><input type="checkbox" name="ì•½ë¬¼/íˆ¬ì•½" value="endtime" /> ENDTIME (ì¢…ë£Œì‹œê°)</label>
            <label><input type="checkbox" name="ì•½ë¬¼/íˆ¬ì•½" value="drug_type" /> DRUG_TYPE (ì•½ë¬¼ë¶„ë¥˜)</label>
          </td></tr>
          <tr><td>íˆ¬ì•½ ìƒì„¸</td><td class="column-checkbox-group">
            <label><input type="checkbox" name="ì•½ë¬¼/íˆ¬ì•½" value="dose_val_rx" /> DOSE_VAL_RX (ì²˜ë°©ìš©ëŸ‰)</label>
            <label><input type="checkbox" name="ì•½ë¬¼/íˆ¬ì•½" value="dose_unit_rx" /> DOSE_UNIT_RX (ìš©ëŸ‰ë‹¨ìœ„)</label>
            <label><input type="checkbox" name="ì•½ë¬¼/íˆ¬ì•½" value="medication" /> MEDICATION (íˆ¬ì•½ì•½ë¬¼)</label>
            <label><input type="checkbox" name="ì•½ë¬¼/íˆ¬ì•½" value="charttime" /> CHARTTIME (íˆ¬ì•½ì‹œê°)</label>
            <label><input type="checkbox" name="ì•½ë¬¼/íˆ¬ì•½" value="event_txt" /> EVENT_TXT (ì´ë²¤íŠ¸)</label>
            <label><input type="checkbox" name="ì•½ë¬¼/íˆ¬ì•½" value="orderid" /> ORDERID (ì˜¤ë”ID)</label>
          </td></tr>
          <tr><td>ìˆ˜ì•¡/íˆ¬ì—¬</td><td class="column-checkbox-group">
            <label><input type="checkbox" name="ì•½ë¬¼/íˆ¬ì•½" value="amount" /> AMOUNT (íˆ¬ì—¬ëŸ‰)</label>
            <label><input type="checkbox" name="ì•½ë¬¼/íˆ¬ì•½" value="amountuom" /> AMOUNTUOM (íˆ¬ì—¬ë‹¨ìœ„)</label>
            <label><input type="checkbox" name="ì•½ë¬¼/íˆ¬ì•½" value="rate" /> RATE (íˆ¬ì—¬ì†ë„)</label>
            <label><input type="checkbox" name="ì•½ë¬¼/íˆ¬ì•½" value="rateuom" /> RATEUOM (ì†ë„ë‹¨ìœ„)</label>
            <label><input type="checkbox" name="ì•½ë¬¼/íˆ¬ì•½" value="totalamount" /> TOTALAMOUNT (ì´íˆ¬ì—¬ëŸ‰)</label>
          </td></tr>
        </table>

        <!-- 5. ì„ìƒì‹œí—˜ ì„¤ì • -->
        <h3>ì„ìƒì‹œí—˜ ë¶„ì„</h3>
        <table class="ecrf-form-table">
          <tr><td>ê¸°ë³¸ì •ë³´</td><td class="column-checkbox-group">
            <label><input type="checkbox" name="ì„ìƒì‹œí—˜" value="subject_id" checked disabled /> SUBJECT_ID (í™˜ìID) </label>
            <label><input type="checkbox" name="ì„ìƒì‹œí—˜" value="hadm_id" checked disabled /> HADM_ID (ì…ì›ID) </label>
            <label><input type="checkbox" name="ì„ìƒì‹œí—˜" value="gender" /> GENDER (ì„±ë³„)</label>
            <label><input type="checkbox" name="ì„ìƒì‹œí—˜" value="anchor_age" /> ANCHOR_AGE (ë‚˜ì´)</label>
            <label><input type="checkbox" name="ì„ìƒì‹œí—˜" value="admittime" /> ADMITTIME (ì…ì›ì¼)</label>
          </td></tr>
          <tr><td>ì§„ë‹¨/ì•½ë¬¼</td><td class="column-checkbox-group">
            <label><input type="checkbox" name="ì„ìƒì‹œí—˜" value="icd_code" /> ICD_CODE (ì§„ë‹¨ì½”ë“œ)</label>
            <label><input type="checkbox" name="ì„ìƒì‹œí—˜" value="short_title" /> SHORT_TITLE (ì§„ë‹¨ëª…)</label>
            <label><input type="checkbox" name="ì„ìƒì‹œí—˜" value="drug" /> DRUG (ì•½í’ˆëª…)</label>
            <label><input type="checkbox" name="ì„ìƒì‹œí—˜" value="drug_type" /> DRUG_TYPE (ì•½ë¬¼ë¶„ë¥˜)</label>
          </td></tr>
          <tr><td>ê²€ì‚¬/ì„ìƒì‹œí—˜</td><td class="column-checkbox-group">
            <label><input type="checkbox" name="ì„ìƒì‹œí—˜" value="itemid" /> ITEMID (ê²€ì‚¬í•­ëª©)</label>
            <label><input type="checkbox" name="ì„ìƒì‹œí—˜" value="value" /> VALUE (ê²€ì‚¬ê°’)</label>
            <label><input type="checkbox" name="ì„ìƒì‹œí—˜" value="charttime" /> CHARTTIME (ê²€ì‚¬ì‹œê°)</label>
          </td></tr>
        </table>

        <!-- ë²„íŠ¼ ê·¸ë£¹ -->
        <button id="reset-settings-btn" style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 1.05em;">ì´ˆê¸°í™”</button>
      </div>
    </section>

    <!-- ì±—ë´‡ -->
    <section id="tab-chatbot" class="ecrf-tab-content" style="display:none;">
      <h2>AI ì–´ì‹œìŠ¤í„´íŠ¸</h2>

      <!-- ì‹œìŠ¤í…œ ë©”ì‹œì§€ -->
      <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin-bottom: 20px; text-align: center; color: #856404;">
        ğŸ’¡ í˜„ì¬ ì»¬ëŸ¼ ì„¤ì •ì´ ì ìš©ëœ ì±„íŒ…ì…ë‹ˆë‹¤
      </div>

      <!-- ì±—ë´‡ ì˜ì—­ -->
      <div id="tab-chatbot-area">
        <!-- ì±„íŒ… ë©”ì‹œì§€ ì˜ì—­ -->
        <div id="tab-chatbot-messages">
          <div class="chat-message ai">
            <div class="message-content">
              ì•ˆë…•í•˜ì„¸ìš”! ì˜ë£Œ ë°ì´í„° ë¶„ì„ì„ ë„ì™€ë“œë¦´ AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?
            </div>
          </div>
        </div>

        <!-- ì…ë ¥ ì˜ì—­ -->
        <div id="tab-chatbot-input-area">
          <input type="text" id="tab-chatbot-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”... (ì˜ˆ: 65ì„¸ ì´ìƒ í™˜ì ëª©ë¡ ì¡°íšŒ)">
          <button id="tab-chatbot-send" onclick="sendMessage();" style="z-index: 999999 !important; position: relative !important;">ì „ì†¡</button>
        </div>
      </div>
    </section>

  </main>
</div>

<script>
// í”„ë¦¬ì…‹ ì •ì˜
const COLUMN_PRESETS = {
  basic: {
    name: "ê¸°ë³¸ ì„¤ì •",
    settings: {
      "í™˜ì/ì…ì›": ["hadm_id", "admittime", "dischtime"],
      "ê²€ì‚¬/ë°”ì´íƒˆ": ["label", "valuenum", "valueuom"],
      "ì§„ë‹¨/ì‹œìˆ ": ["short_title"],
      "ì•½ë¬¼/íˆ¬ì•½": ["endtime", "drug_type"],
      "ì„ìƒì‹œí—˜": ["gender", "anchor_age"]
    }
  },
  detailed: {
    name: "ìƒì„¸ ë¶„ì„",
    settings: {
      "í™˜ì/ì…ì›": ["dod", "hadm_id", "admittime", "dischtime", "admission_type", "stay_id", "intime", "outtime", "los"],
      "ê²€ì‚¬/ë°”ì´íƒˆ": ["label", "valuenum", "valueuom", "storetime", "warning", "test_name", "org_name"],
      "ì§„ë‹¨/ì‹œìˆ ": ["short_title", "long_title", "drg_code", "drg_severity"],
      "ì•½ë¬¼/íˆ¬ì•½": ["endtime", "drug_type", "dose_val_rx", "medication", "amount", "rate"],
      "ì„ìƒì‹œí—˜": ["gender", "anchor_age", "admittime", "icd_code", "drug", "itemid", "value"]
    }
  },
  simple: {
    name: "ê°„ë‹¨ ì¡°íšŒ",
    settings: {
      "í™˜ì/ì…ì›": ["hadm_id"],
      "ê²€ì‚¬/ë°”ì´íƒˆ": ["label", "valuenum"],
      "ì§„ë‹¨/ì‹œìˆ ": ["short_title"],
      "ì•½ë¬¼/íˆ¬ì•½": ["drug_type"],
      "ì„ìƒì‹œí—˜": ["gender"]
    }
  },
  research: {
    name: "ì—°êµ¬ìš©",
    settings: {
      "í™˜ì/ì…ì›": ["hadm_id", "admittime", "anchor_year"],
      "ê²€ì‚¬/ë°”ì´íƒˆ": ["label", "valuenum", "charttime", "test_name", "interpretation"],
      "ì§„ë‹¨/ì‹œìˆ ": ["short_title", "icd_version", "drg_severity"],
      "ì•½ë¬¼/íˆ¬ì•½": ["drug_type", "starttime", "endtime", "amount"],
      "ì„ìƒì‹œí—˜": ["gender", "anchor_age", "admittime", "icd_code", "short_title", "drug", "itemid", "value", "charttime"]
    }
  }
};

// ì‚¬ìš©ì ì •ì˜ í”„ë¦¬ì…‹ ì €ì¥ì†Œ
let userPresets = JSON.parse(localStorage.getItem('userColumnPresets') || '{}');

// í˜„ì¬ ì„¤ì •ì„ í”„ë¦¬ì…‹ìœ¼ë¡œ ì €ì¥
document.getElementById('save-as-preset-btn').onclick = function() {
  const presetName = prompt('í”„ë¦¬ì…‹ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:');
  if (!presetName) return;

  const currentSettings = {};
  const categories = ["í™˜ì/ì…ì›", "ê²€ì‚¬/ë°”ì´íƒˆ", "ì§„ë‹¨/ì‹œìˆ ", "ì•½ë¬¼/íˆ¬ì•½", "ì„ìƒì‹œí—˜"];

  categories.forEach(category => {
    const checkedBoxes = document.querySelectorAll(`input[name="${category}"]:checked`);
    currentSettings[category] = Array.from(checkedBoxes).map(cb => cb.value);
  });

  userPresets[presetName] = {
    name: presetName,
    settings: currentSettings
  };

  localStorage.setItem('userColumnPresets', JSON.stringify(userPresets));

  // í”„ë¦¬ì…‹ ì„ íƒ ë“œë¡­ë‹¤ìš´ì— ì¶”ê°€
  updatePresetSelector();

  alert(`"${presetName}" í”„ë¦¬ì…‹ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
};

// í”„ë¦¬ì…‹ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
function updatePresetSelector() {
  const selector = document.getElementById('preset-selector');

  // ì‚¬ìš©ì ì •ì˜ í”„ë¦¬ì…‹ ì˜µì…˜ë“¤ ì œê±°
  Array.from(selector.options).forEach(option => {
    if (!['', 'basic', 'detailed', 'simple', 'research'].includes(option.value)) {
      option.remove();
    }
  });

  // ì‚¬ìš©ì ì •ì˜ í”„ë¦¬ì…‹ ì¶”ê°€
  Object.entries(userPresets).forEach(([key, preset]) => {
    const option = document.createElement('option');
    option.value = key;
    option.textContent = `${preset.name} (ì‚¬ìš©ì ì •ì˜)`;
    selector.appendChild(option);
  });
}

// ì´ ì½”ë“œë“¤ë¡œ êµì²´
document.getElementById('preset-selector').onchange = function() {
  const selectedPreset = this.value;
  if (!selectedPreset) return;

  const preset = COLUMN_PRESETS[selectedPreset] || userPresets[selectedPreset];
  if (!preset) return;

  document.querySelectorAll('input[type="checkbox"]:not([disabled])').forEach(cb => cb.checked = false);

  Object.entries(preset.settings).forEach(([category, columns]) => {
    columns.forEach(column => {
      const checkbox = document.querySelector(`input[name="${category}"][value="${column}"]`);
      if (checkbox && !checkbox.disabled) checkbox.checked = true;
    });
  });

  saveCurrentSettings();
};

function saveCurrentSettings() {
  const settings = {};
  const categories = ["í™˜ì/ì…ì›", "ê²€ì‚¬/ë°”ì´íƒˆ", "ì§„ë‹¨/ì‹œìˆ ", "ì•½ë¬¼/íˆ¬ì•½", "ì„ìƒì‹œí—˜"];

  categories.forEach(category => {
    const checkedBoxes = document.querySelectorAll(`input[name="${category}"]:checked:not([disabled])`);
    settings[category] = {
      selected_optional: Array.from(checkedBoxes).map(cb => cb.value)
    };
  });

  fetch('http://127.0.0.1:8000/api/save_column_settings', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(settings)
  }).then(res => res.json()).then(data => {
    if (data.success) console.log('ìë™ ì €ì¥ ì™„ë£Œ');
  });
}

document.addEventListener('change', function(e) {
  if (e.target.type === 'checkbox' && e.target.name) {
    saveCurrentSettings();
  }
});

// ì´ˆê¸°í™”
document.getElementById('reset-settings-btn').onclick = function() {
  if (confirm('ëª¨ë“  ì„¤ì •ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
    document.querySelectorAll('input[type="checkbox"]:not([disabled])').forEach(cb => {
      cb.checked = false;
    });
    document.getElementById('preset-selector').value = '';
  }
};

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì‚¬ìš©ì ì •ì˜ í”„ë¦¬ì…‹ ë¶ˆëŸ¬ì˜¤ê¸°
document.addEventListener('DOMContentLoaded', function() {
  updatePresetSelector();
});

fetch('http://127.0.0.1:8000/api/get_column_settings')
.then(res => res.json())
.then(data => {
  Object.entries(data).forEach(([category, config]) => {
    const selectedCols = config.user_selected || [];
    selectedCols.forEach(col => {
      const checkbox = document.querySelector(`input[name="${category}"][value="${col}"]`);
      if (checkbox && !checkbox.disabled) checkbox.checked = true;
    });
  });
});


// ê¸°ì¡´ sendMessage í•¨ìˆ˜ë¥¼ ì‹¤ì œ AI ì—°ê²° ë²„ì „ìœ¼ë¡œ êµì²´
window.sendMessage = function() {
  const chatInput = document.getElementById('tab-chatbot-input');
  const chatMessages = document.getElementById('tab-chatbot-messages');
  const message = chatInput.value.trim();
  if (!message) return;

  // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
  const messageDiv = document.createElement('div');
  messageDiv.className = 'chat-message user';
  const contentDiv = document.createElement('div');
  contentDiv.className = 'message-content';
  contentDiv.textContent = message;
  messageDiv.appendChild(contentDiv);
  chatMessages.appendChild(messageDiv);

  chatInput.value = '';

  // ë¡œë”© ë©”ì‹œì§€
  const loadingDiv = document.createElement('div');
  loadingDiv.className = 'chat-message ai';
  loadingDiv.id = 'loading-message';
  const loadingContent = document.createElement('div');
  loadingContent.className = 'message-content';
  loadingContent.textContent = 'ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...';
  loadingDiv.appendChild(loadingContent);
  chatMessages.appendChild(loadingDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;

  // í˜„ì¬ í™œì„± íƒ­ê³¼ ì»¬ëŸ¼ ì„¤ì • ì •ë³´ë„ í•¨ê»˜ ì „ì†¡
  const activeTab = document.querySelector('.ecrf-tab-btn.active').textContent;
  const columnSettings = window.collectSettings();

  fetch('http://127.0.0.1:8000/chat', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      message: message,
      chat_history: [],
      active_tab: activeTab,
      column_settings: columnSettings
    })
  })
  .then(res => res.json())
  .then(data => {
    const loading = document.getElementById('loading-message');
    if (loading) loading.remove();

    const aiDiv = document.createElement('div');
    aiDiv.className = 'chat-message ai';
    const aiContentDiv = document.createElement('div');
    aiContentDiv.className = 'message-content';

    // í…ìŠ¤íŠ¸ ì‘ë‹µ ì¶”ê°€
    const textResponse = document.createElement('div');
    textResponse.style.marginBottom = '15px';
    textResponse.textContent = data.report_text || 'ì‘ë‹µì„ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
    aiContentDiv.appendChild(textResponse);

    // ğŸ”¥ ìˆ˜ì •: ê²°ê³¼ë¥¼ ë²„ë¸” ì•ˆì— í‘œì‹œ
    if (data.db_result && data.db_result.length > 0) {
      const resultContainer = document.createElement('div');
      resultContainer.style.cssText = `
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
        max-height: 400px;
        overflow-y: auto;
      `;

      // SQL í† ê¸€ ë²„íŠ¼
      if (data.sql) {
        const sqlToggleBtn = document.createElement('button');
        sqlToggleBtn.textContent = 'SQL ë³´ê¸°';
        sqlToggleBtn.style.cssText = `
          background: #3A86FF;
          color: white;
          border: none;
          padding: 5px 12px;
          border-radius: 5px;
          font-size: 0.85em;
          cursor: pointer;
          margin-bottom: 10px;
        `;

        const sqlDiv = document.createElement('div');
        sqlDiv.style.cssText = `
          background: #2d3748;
          color: #e2e8f0;
          padding: 10px;
          border-radius: 5px;
          font-family: 'Courier New', monospace;
          font-size: 0.85em;
          margin-bottom: 15px;
          display: none;
          white-space: pre-wrap;
          word-break: break-all;
        `;
        sqlDiv.textContent = data.sql;

        let sqlVisible = false;
        sqlToggleBtn.onclick = function() {
          sqlVisible = !sqlVisible;
          sqlDiv.style.display = sqlVisible ? 'block' : 'none';
          sqlToggleBtn.textContent = sqlVisible ? 'SQL ìˆ¨ê¸°ê¸°' : 'SQL ë³´ê¸°';
        };

        resultContainer.appendChild(sqlToggleBtn);
        resultContainer.appendChild(sqlDiv);
      }

      // ê²°ê³¼ í…Œì´ë¸”
      const tableContainer = document.createElement('div');
      tableContainer.style.cssText = `
        background: white;
        border-radius: 5px;
        overflow: auto;
        max-height: 300px;
      `;

      const table = document.createElement('table');
      table.style.cssText = `
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85em;
      `;

      // ì»¬ëŸ¼ëª… ë§¤í•‘ (í•œê¸€ í‘œì‹œìš©)
      const COLUMN_KR_MAP = {
        'SUBJECT_ID': 'í™˜ìID',
        'HADM_ID': 'ì…ì›ID',
        'GENDER': 'ì„±ë³„',
        'ANCHOR_AGE': 'ë‚˜ì´',
        'ADMITTIME': 'ì…ì›ì¼',
        'ICD_CODE': 'ì§„ë‹¨ì½”ë“œ',
        'SHORT_TITLE': 'ì§„ë‹¨ëª…',
        'DRUG': 'ì•½í’ˆëª…',
        'DRUG_TYPE': 'ì•½ë¬¼ë¶„ë¥˜',
        'ITEMID': 'ê²€ì‚¬í•­ëª©',
        'VALUE': 'ê²€ì‚¬ê°’',
        'CHARTTIME': 'ê²€ì‚¬ì‹œê°'
      };

      // í…Œì´ë¸” í—¤ë”
      if (data.columns && data.columns.length > 0) {
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        headerRow.style.backgroundColor = '#f8f9fa';

        data.columns.forEach(col => {
          const th = document.createElement('th');
          th.style.cssText = `
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            font-weight: 600;
            text-align: left;
          `;
          th.textContent = COLUMN_KR_MAP[col.toUpperCase()] || col;
          headerRow.appendChild(th);
        });

        thead.appendChild(headerRow);
        table.appendChild(thead);
      }

      // í…Œì´ë¸” ë°”ë””
      const tbody = document.createElement('tbody');
      data.db_result.slice(0, 50).forEach((row, index) => { // ìµœëŒ€ 50ê°œ í–‰ë§Œ í‘œì‹œ
        const tr = document.createElement('tr');
        if (index % 2 === 1) tr.style.backgroundColor = '#f8f9fa';

        data.columns.forEach(col => {
          const td = document.createElement('td');
          td.style.cssText = `
            padding: 6px 12px;
            border: 1px solid #dee2e6;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
          `;
          td.textContent = row[col] || '';
          td.title = row[col] || ''; // íˆ´íŒìœ¼ë¡œ ì „ì²´ ë‚´ìš© í‘œì‹œ
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });
      table.appendChild(tbody);

      tableContainer.appendChild(table);
      resultContainer.appendChild(tableContainer);

      // ê²°ê³¼ ê°œìˆ˜ í‘œì‹œ
      if (data.db_result.length > 50) {
        const countInfo = document.createElement('div');
        countInfo.style.cssText = `
          margin-top: 10px;
          font-size: 0.8em;
          color: #6c757d;
          text-align: center;
        `;
        countInfo.textContent = `ì´ ${data.db_result.length}ê°œ ê²°ê³¼ ì¤‘ 50ê°œë§Œ í‘œì‹œë©ë‹ˆë‹¤.`;
        resultContainer.appendChild(countInfo);
      } else {
        const countInfo = document.createElement('div');
        countInfo.style.cssText = `
          margin-top: 10px;
          font-size: 0.8em;
          color: #6c757d;
          text-align: center;
        `;
        countInfo.textContent = `ì´ ${data.db_result.length}ê°œì˜ ê²°ê³¼ì…ë‹ˆë‹¤.`;
        resultContainer.appendChild(countInfo);
      }

      aiContentDiv.appendChild(resultContainer);
    }

    aiDiv.appendChild(aiContentDiv);
    chatMessages.appendChild(aiDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
  })
  .catch(error => {
    console.error('8000 í¬íŠ¸ ì—°ê²° ì‹¤íŒ¨:', error);

    const loading = document.getElementById('loading-message');
    if (loading) loading.remove();

    const errorDiv = document.createElement('div');
    errorDiv.className = 'chat-message ai';
    const errorContent = document.createElement('div');
    errorContent.className = 'message-content';
    errorContent.textContent = 'âŒ 8000ë²ˆ í¬íŠ¸ ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. AI ì„œë²„(app.py)ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”.';
    errorDiv.appendChild(errorContent);
    chatMessages.appendChild(errorDiv);

    chatMessages.scrollTop = chatMessages.scrollHeight;
  });
};

console.log('âœ… 8000ë²ˆ í¬íŠ¸ ì—°ê²° í•¨ìˆ˜ ì¤€ë¹„ ì™„ë£Œ');


// íƒ­ ì „í™˜ ê¸°ëŠ¥
document.addEventListener('DOMContentLoaded', function() {
  const tabBtns = document.querySelectorAll('.ecrf-tab-btn');
  const tabContents = document.querySelectorAll('.ecrf-tab-content');

  tabBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      // ëª¨ë“  íƒ­ ìˆ¨ê¸°ê¸°
      tabContents.forEach(content => content.style.display = 'none');

      // ëª¨ë“  ë²„íŠ¼ ë¹„í™œì„±í™”
      tabBtns.forEach(b => b.classList.remove('active'));

      // í´ë¦­í•œ íƒ­ ë³´ì´ê¸°
      const targetTab = document.getElementById(btn.dataset.tab);
      if (targetTab) {
        targetTab.style.display = 'block';
        btn.classList.add('active');
      }
    });
  });

  // ì²« ë²ˆì§¸ íƒ­ í™œì„±í™”
  if (tabBtns.length > 0) {
    tabBtns[0].click();
  }

  // ì €ì¥ëœ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
  loadSavedSettings();

  // ì±—ë´‡ ê¸°ëŠ¥ - Enter í‚¤ ì´ë²¤íŠ¸ë§Œ ì¶”ê°€ (onclickì€ HTMLì—ì„œ ì²˜ë¦¬)
  const chatInput = document.getElementById('tab-chatbot-input');
  if (chatInput) {
    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });
  }
});
</script>